<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>如何使用通用的Hibernate类型映射JSON对象 - 魔都水滴</title>
<meta name="description" content="介绍 在本文中，我们将看到如何使用Hibernate Types开源项目将JSON列映射到JPA实体属性。 虽然您可以创建自己的自定义Hibernate类型，但可以在Oracle，SQL Server，PostgreSQL或MySQL上映射JSON列类型，但是由于Hibernate Types项目已经提供了此功能，因此 …">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://blog.margrop.net/post/how-to-map-json-collections-using-jpa-and-hibernate/">

<meta property="og:site_name" content="魔都水滴">
<meta property="og:title" content="如何使用通用的Hibernate类型映射JSON对象 - 魔都水滴">
<meta property="og:description" content="介绍 在本文中，我们将看到如何使用Hibernate Types开源项目将JSON列映射到JPA实体属性。 虽然您可以创建自己的自定义Hibernate类型，但可以在Oracle，SQL Server，PostgreSQL或MySQL上映射JSON列类型，但是由于Hibernate Types项目已经提供了此功能，因此 …">
<meta property="og:url" content="https://blog.margrop.net/post/how-to-map-json-collections-using-jpa-and-hibernate/">
<meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.margrop.net/images/avatar.png"><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="如何使用通用的Hibernate类型映射JSON对象 - 魔都水滴">
<meta name="twitter:description" content="介绍 在本文中，我们将看到如何使用Hibernate Types开源项目将JSON列映射到JPA实体属性。 虽然您可以创建自己的自定义Hibernate类型，但可以在Oracle，SQL Server，PostgreSQL或MySQL上映射JSON列类型，但是由于Hibernate Types项目已经提供了此功能，因此 …"><meta name="twitter:image" content="https://blog.margrop.net/images/avatar.png"><meta property="article:published_time" content="2021-01-29T16:06:09&#43;08:00">
<meta property="article:modified_time" content="2021-01-29T16:06:09&#43;08:00"><meta property="article:tag" content="java"><meta property="article:tag" content="jpa"><meta property="article:tag" content="hibernate"><meta property="article:tag" content="json"><meta property="article:tag" content="jsonb"><meta property="article:tag" content="maven"><meta property="article:tag" content="MySQL"><meta property="article:tag" content="PostgreSQL"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"魔都水滴"},"dateModified":"2021-01-29T16:06:09+08:00","datePublished":"2021-01-29T16:06:09+08:00","description":"介绍 在本文中，我们将看到如何使用Hibernate Types开源项目将JSON列映射到JPA实体属性。 虽然您可以创建自己的自定义Hibernate类型，但可以在Oracle，SQL Server，PostgreSQL或MySQL上映射JSON列类型，但是由于Hibernate Types项目已经提供了此功能，因此 …","headline":"如何使用通用的Hibernate类型映射JSON对象","mainEntityOfPage":"https://blog.margrop.net/post/how-to-map-json-collections-using-jpa-and-hibernate/","url":"https://blog.margrop.net/post/how-to-map-json-collections-using-jpa-and-hibernate/"}</script>
    <meta name="baidu-site-verification" content="code-sVFZ8SER59" />
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J2W592DHJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3J2W592DHJ');
    </script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.8; }
        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
        .content { line-height: 1.8; }
        .content code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        .content pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }
        .content img { max-width: 100%; height: auto; }
        .tags { margin-top: 30px; }
        .tag { background: #eee; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
        nav { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        nav a { margin-right: 20px; text-decoration: none; color: #333; font-size: 16px; }
        nav a:hover { color: #006CFF; }
        a { color: #006CFF; }
    </style>
</head>
<body>
    <nav>
  <a href="/">首页</a>
  <a href="/post/">归档</a>
  <a href="/tags/">标签</a>
  <a href="/post/about">关于</a>
  <a href="https://download.margrop.net" target="_blank">下载</a>
  <a href="/post/favorites">Link</a>
  <a href="/post/github-project-stars">Github</a>
  <a href="https://github-mirrors.margrop.net" target="_blank">Github加速</a>
  <a href="https://docker-mirrors.margrop.net" target="_blank">Docker加速</a>
</nav>

    <article>
        <h1>如何使用通用的Hibernate类型映射JSON对象</h1>
        <div class="meta">
            发布时间: 2021-01-29
            
            | 标签: 
            
                
                <a href="/tag/java"><span class="tag">java</span></a>
            
                
                <a href="/tag/jpa"><span class="tag">jpa</span></a>
            
                
                <a href="/tag/hibernate"><span class="tag">hibernate</span></a>
            
                
                <a href="/tag/json"><span class="tag">json</span></a>
            
                
                <a href="/tag/jsonb"><span class="tag">jsonb</span></a>
            
                
                <a href="/tag/maven"><span class="tag">maven</span></a>
            
                
                <a href="/tag/mysql"><span class="tag">MySQL</span></a>
            
                
                <a href="/tag/postgresql"><span class="tag">PostgreSQL</span></a>
            
            
        </div>
        <div class="content">
            <h1 id="介绍">介绍</h1>
<p>在本文中，我们将看到如何使用<a href="http://www.google.com/" title="Hibernate Types">Hibernate Types</a>开源项目将JSON列映射到JPA实体属性。</p>
<p>虽然您可以创建自己的自定义Hibernate类型，但可以在Oracle，SQL Server，PostgreSQL或MySQL上映射JSON列类型，但是由于<a href="http://www.google.com/" title="Hibernate Types">Hibernate Types</a>项目已经提供了此功能，因此您无需实现自己的Hibernate Type 。</p>
<h1 id="领域模型">领域模型</h1>
<p>假设我们具有以下域模型：
<img src="https://vladmihalcea.com/wp-content/uploads/2016/06/jsontypedomainmodel.png" alt="JsonType域模型"></p>
<p>Location和Ticket是JSON Object(s)，而Event和Participant是JPA实体。我们的目标是提供一种Type适用于任何类型的JSON JavaObject以及支持JSON列的任何关系数据库的Hibernate JSON 。</p>
<h1 id="maven依赖">Maven依赖</h1>
<p>您需要做的第一件事是在项目pom.xml配置文件中设置以下Maven依赖项：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.vladmihalcea<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>hibernate-types-52<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>${hibernate-types.version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>如果您使用的是Hibernate的旧版本，请查看<a href="https://github.com/vladmihalcea/hibernate-types">hibernate-types<code>GitHub存储库</code></a>，以获取有关当前Hibernate版本的匹配依赖项的更多信息。</p>
<h1 id="声明hibernate-types">声明Hibernate Types</h1>
<p>要使用JSON Hibernate Types，我们必须使用@TypeDef注释声明它们：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@TypeDefs</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@TypeDef</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>, typeClass <span style="color:#f92672">=</span> JsonStringType.<span style="color:#a6e22e">class</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@TypeDef</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jsonb&#34;</span>, typeClass <span style="color:#f92672">=</span> JsonBinaryType.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@MappedSuperclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseEntity</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Code omitted for brevity</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>TypeDef批注可以应用于基本实体类，也可以应用于与当前实体包关联的package-info.java文件。</p>
</blockquote>
<h1 id="mysql">MySQL</h1>
<p>MySQL 5.7增加了对JSON类型的支持，在JDBC级别上，需要将其实现为String。因此，我们将使用JsonStringType。</p>
<p>实体映射如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Entity</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Event&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Table</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;event&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Event</span> <span style="color:#66d9ef">extends</span> BaseEntity {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Type</span>(type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Column</span>(columnDefinition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Location location;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Location <span style="color:#a6e22e">getLocation</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> location;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setLocation</span>(Location location) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> location;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Entity</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Participant&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Table</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;participant&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Participant</span> <span style="color:#66d9ef">extends</span> BaseEntity {
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Type</span>(type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Column</span>(columnDefinition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Ticket ticket;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ManyToOne</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Event event;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Ticket <span style="color:#a6e22e">getTicket</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ticket;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setTicket</span>(Ticket ticket) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">ticket</span> <span style="color:#f92672">=</span> ticket;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Event <span style="color:#a6e22e">getEvent</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> event;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setEvent</span>(Event event) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">event</span> <span style="color:#f92672">=</span> event;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>插入以下实体时：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> AtomicReference<span style="color:#f92672">&lt;</span>Event<span style="color:#f92672">&gt;</span> eventHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicReference<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> AtomicReference<span style="color:#f92672">&lt;</span>Participant<span style="color:#f92672">&gt;</span> participantHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicReference<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>doInJPA(entityManager <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>    Event nullEvent <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Event();
</span></span><span style="display:flex;"><span>    nullEvent.<span style="color:#a6e22e">setId</span>(0L);
</span></span><span style="display:flex;"><span>    entityManager.<span style="color:#a6e22e">persist</span>(nullEvent);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    Location location <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Location();
</span></span><span style="display:flex;"><span>    location.<span style="color:#a6e22e">setCountry</span>(<span style="color:#e6db74">&#34;Romania&#34;</span>);
</span></span><span style="display:flex;"><span>    location.<span style="color:#a6e22e">setCity</span>(<span style="color:#e6db74">&#34;Cluj-Napoca&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    Event event <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Event();
</span></span><span style="display:flex;"><span>    event.<span style="color:#a6e22e">setId</span>(1L);
</span></span><span style="display:flex;"><span>    event.<span style="color:#a6e22e">setLocation</span>(location);
</span></span><span style="display:flex;"><span>    entityManager.<span style="color:#a6e22e">persist</span>(event);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    Ticket ticket <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Ticket();
</span></span><span style="display:flex;"><span>    ticket.<span style="color:#a6e22e">setPrice</span>(12.<span style="color:#a6e22e">34d</span>);
</span></span><span style="display:flex;"><span>    ticket.<span style="color:#a6e22e">setRegistrationCode</span>(<span style="color:#e6db74">&#34;ABC123&#34;</span>);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    Participant participant <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Participant();
</span></span><span style="display:flex;"><span>    participant.<span style="color:#a6e22e">setId</span>(1L);
</span></span><span style="display:flex;"><span>    participant.<span style="color:#a6e22e">setTicket</span>(ticket);
</span></span><span style="display:flex;"><span>    participant.<span style="color:#a6e22e">setEvent</span>(event);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    entityManager.<span style="color:#a6e22e">persist</span>(participant);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    eventHolder.<span style="color:#a6e22e">set</span>(event);
</span></span><span style="display:flex;"><span>    participantHolder.<span style="color:#a6e22e">set</span>(participant);
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Hibernate生成以下语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>INSERT INTO <span style="color:#a6e22e">event</span> (location, id)
</span></span><span style="display:flex;"><span>VALUES (NULL(OTHER), 0)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>INSERT INTO <span style="color:#a6e22e">event</span> (location, id)
</span></span><span style="display:flex;"><span>VALUES (<span style="color:#960050;background-color:#1e0010">&#39;</span>{<span style="color:#e6db74">&#34;country&#34;</span>:<span style="color:#e6db74">&#34;Romania&#34;</span>,<span style="color:#e6db74">&#34;city&#34;</span>:<span style="color:#e6db74">&#34;Cluj-Napoca&#34;</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>, 1)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>INSERT INTO <span style="color:#a6e22e">participant</span> (event_id, ticket, id)
</span></span><span style="display:flex;"><span>VALUES (1, {<span style="color:#e6db74">&#34;registrationCode&#34;</span>:<span style="color:#e6db74">&#34;ABC123&#34;</span>,<span style="color:#e6db74">&#34;price&#34;</span>:12.<span style="color:#a6e22e">34</span>}, 1)
</span></span></code></pre></div><p>JSONObject(s)已正确实现在其关联的数据库列中。</p>
<p>不仅JSONObject(s)已从其数据库表示形式正确转换：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Event event <span style="color:#f92672">=</span> entityManager.<span style="color:#a6e22e">find</span>(Event.<span style="color:#a6e22e">class</span>, eventHolder.<span style="color:#a6e22e">get</span>().<span style="color:#a6e22e">getId</span>());
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#e6db74">&#34;Cluj-Napoca&#34;</span>, event.<span style="color:#a6e22e">getLocation</span>().<span style="color:#a6e22e">getCity</span>());
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Participant participant <span style="color:#f92672">=</span> entityManager.<span style="color:#a6e22e">find</span>(
</span></span><span style="display:flex;"><span>    Participant.<span style="color:#a6e22e">class</span>, participantHolder.<span style="color:#a6e22e">get</span>().<span style="color:#a6e22e">getId</span>());
</span></span><span style="display:flex;"><span>assertEquals(<span style="color:#e6db74">&#34;ABC123&#34;</span>, participant.<span style="color:#a6e22e">getTicket</span>().<span style="color:#a6e22e">getRegistrationCode</span>());
</span></span></code></pre></div><p>但是我们甚至可以发出基于JSON的本地SQL查询：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> participants <span style="color:#f92672">=</span> entityManager.<span style="color:#a6e22e">createNativeQuery</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;SELECT p.ticket -&gt; \&#34;$.registrationCode\&#34; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;FROM participant p &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;WHERE JSON_EXTRACT(p.ticket, \&#34;$.price\&#34;) &gt; 1 &#34;</span>)
</span></span><span style="display:flex;"><span>.<span style="color:#a6e22e">getResultList</span>();
</span></span></code></pre></div><p>Object(s)可以修改JSON ：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>event.<span style="color:#a6e22e">getLocation</span>().<span style="color:#a6e22e">setCity</span>(<span style="color:#e6db74">&#34;Constanța&#34;</span>);
</span></span><span style="display:flex;"><span>entityManager.<span style="color:#a6e22e">flush</span>();
</span></span></code></pre></div><p>Hibernate生成正确的UPDATE语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>UPDATE event
</span></span><span style="display:flex;"><span>SET location <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>{<span style="color:#e6db74">&#34;country&#34;</span>:<span style="color:#e6db74">&#34;Romania&#34;</span>,<span style="color:#e6db74">&#34;city&#34;</span>:<span style="color:#e6db74">&#34;Constanța&#34;</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>WHERE id <span style="color:#f92672">=</span> 1
</span></span></code></pre></div><h1 id="postgresql">PostgreSQL</h1>
<p>从9.2版开始，PostgreSQL就一直支持JSON类型。有两种类型可以使用：</p>
<ul>
<li>json</li>
<li>jsonb
两种PostgreSQL JSON类型都需要使用二进制数据格式来实现，因此我们需要使用JsonBinaryType这次。</li>
</ul>
<h1 id="postgresql-json列类型">PostgreSQL JSON列类型</h1>
<p>对于JSON列类型，Object(s)必须如下更改两个JSON映射：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Type</span>(type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jsonb&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Column</span>(columnDefinition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Location location;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Type</span>(type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jsonb&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Column</span>(columnDefinition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;json&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Ticket ticket;
</span></span></code></pre></div><p>插入和实体更新都一样，甚至可以JSON按以下方式查询该列：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> participants <span style="color:#f92672">=</span> entityManager.<span style="color:#a6e22e">createNativeQuery</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;SELECT p.ticket -&gt;&gt;&#39;registrationCode&#39; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;FROM participant p &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;WHERE p.ticket -&gt;&gt; &#39;price&#39; &gt; &#39;10&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>.<span style="color:#a6e22e">getResultList</span>();
</span></span></code></pre></div><h1 id="postgresql-jsonb列类型">PostgreSQL JSONB列类型</h1>
<p>对于JSONB列类型，我们只需要更改columnDefinition属性，因为json和jsonbPostgreSQL列类型都由来处理JsonBinaryType：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Type</span>(type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jsonb&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Column</span>(columnDefinition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jsonb&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Location location;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Type</span>(type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jsonb&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Column</span>(columnDefinition <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jsonb&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Ticket ticket;
</span></span></code></pre></div><p>插入和JSONObject更新的工作方式相同，而JSONB列类型提供了更高级的查询功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> participants <span style="color:#f92672">=</span> entityManager.<span style="color:#a6e22e">createNativeQuery</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;SELECT jsonb_pretty(p.ticket) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;FROM participant p &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;WHERE p.ticket -&gt;&gt; &#39;price&#39; &gt; &#39;10&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>.<span style="color:#a6e22e">getResultList</span>();
</span></span></code></pre></div><p>参考
<a href="https://vladmihalcea.com/how-to-map-json-objects-using-generic-hibernate-types/">How to map JSON objects using generic Hibernate Types</a></p>
        </div>
    </article>
    
    
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container" style="margin-top:40px"></div>
<script>
  (function(){
    var gitalk = new Gitalk({
      clientID: '3181fd94e501cc5db0ad',
      clientSecret: 'af1dab79dae02c69296e6615bfcecf47fc8615ee',
      repo: 'margropcomment.margrop.io',
      owner: 'margrop',
      admin: ["margrop"],
      
      id: '\/post\/how-to-map-json-collections-using-jpa-and-h',
      
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  })();
</script>
  



    <script type="text/javascript" src="https://js.users.51.la/21044367.js"></script>
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({id: "1vVTUWl7zoRjnKXi",ck: "1vVTUWl7zoRjnKXi"})</script>
    <script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script>
    <script>
      new LingQue.Monitor().init({id:"202teQt8THXwqyve"});
    </script>
</body>
</html>
