<!doctype html>
<html lang="cn"><head>
<title>使用 OpenResty + 签名 Cookie 实现登录一次即可长时间免认证的反代安全网关 - 魔都水滴</title>
<meta charset="UTF-8">
<meta name="keywords" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta name="description" content="前言在日常运维工作中，我们经常需要暴露一些 Web 面板或管理后台到公网，方便随时随地访问。然而，公网暴露端口容易被扫描和爆破，给系统带来安全隐患。最近各类 Web 应用的安全事件频发，如何在不修改原应用的情况下，为这些服务增加一层安全防护，成为了一个值得思考的问题。 本文将介绍一种轻量级的加固方案：使用 OpenResty 搭建反向代理网关，通过 BasicAuth 进行首次认证，结合签名 Co">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 OpenResty + 签名 Cookie 实现登录一次即可长时间免认证的反代安全网关">
<meta property="og:url" content="http://blog.margrop.com/post/2026-02-28-openresty-signed-cookie-auth-gateway/index.html">
<meta property="og:site_name" content="魔都水滴">
<meta property="og:description" content="前言在日常运维工作中，我们经常需要暴露一些 Web 面板或管理后台到公网，方便随时随地访问。然而，公网暴露端口容易被扫描和爆破，给系统带来安全隐患。最近各类 Web 应用的安全事件频发，如何在不修改原应用的情况下，为这些服务增加一层安全防护，成为了一个值得思考的问题。 本文将介绍一种轻量级的加固方案：使用 OpenResty 搭建反向代理网关，通过 BasicAuth 进行首次认证，结合签名 Co">
<meta property="og:locale">
<meta property="article:published_time" content="2026-02-28T10:05:00.000Z">
<meta property="article:modified_time" content="2026-02-28T10:07:56.429Z">
<meta property="article:author" content="Margrop">
<meta property="article:tag" content="技术">
<meta property="article:tag" content="安全">
<meta property="article:tag" content="OpenResty">
<meta property="article:tag" content="反向代理">
<meta property="article:tag" content="认证">
<meta name="twitter:card" content="summary">

<link rel="stylesheet" href="../../lib/fancybox/fancybox.css">
<link rel="stylesheet" href="../../lib/mdui_043tiny/mdui.css">


<link rel="stylesheet" href="../../lib/iconfont/iconfont.css?v=1772273956242">

<link rel="stylesheet" href="../../css/style.css?v=1772273956242">




    
        <link rel="stylesheet" href="../../custom.css?v=1772273956242">
    



<script src="../../lib/mdui_043tiny/mdui.js" async></script>
<script src="../../lib/fancybox/fancybox.umd.js" async></script>
<script src="../../lib/lax.min.js" async></script>


<script async src="../../js/app.js?v=1772273956244"></script>

 

<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id:"23bDEwNOu1L8NhV1",ck:"23bDEwNOu1L8NhV1"})</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4NGHEP8LEV"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4NGHEP8LEV');
</script>


<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="atom.xml" title="魔都水滴" type="application/atom+xml">
</head><body class="nexmoe mdui-drawer-body-left"><div id="nexmoe-background"><div class="nexmoe-bg" style="background-image: url(/images/background.webp)"></div><div class="mdui-appbar mdui-shadow-0"><div class="mdui-toolbar"><a class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: &#039;#drawer&#039;, swipe: true}" title="menu"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class="mdui-toolbar-spacer"></div><a class="mdui-btn mdui-btn-icon" href="../../index.html" title="Margrop"><img src="/images/avatar.webp" alt="Margrop"></a></div></div></div><div id="nexmoe-header"><div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="../../index.html" title="Margrop">
            <img src="/images/avatar.webp" alt="Margrop" alt="Margrop">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>Articles</span>165</div>
        <div><span>Tags</span>365</div>
        <div><span>Categories</span>23</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="../../index.html" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="../../post/archives/" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" target="_blank" rel="noopener" href="https://download.margrop.net/" title="下载">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                下载
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="../../post/favorites/" title="常用链接">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                常用链接
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="../../post/github-project-stars/" title="GithubStars">
            <i class="mdui-list-item-icon nexmoefont icon-github"></i>
            <div class="mdui-list-item-content">
                GithubStars
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="../../post/donate/" title="给我赞助">
            <i class="mdui-list-item-icon nexmoefont icon-coffee"></i>
            <div class="mdui-list-item-content">
                给我赞助
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="../../post/about/" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    
    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:margrop.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="Search"></label>
            </form>
         
    </div>
</div>




    
        
        <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=weD8TANNWdCOveAMcdmoAxOKt5owKkDS"
			target="_blank"
			mdui-tooltip="{content: 'QQ群'}"
			style="
				color: rgb(249, 174, 8);
				background-color: rgba(249, 174, 8, .1);
			"
		>
			<i
				class="nexmoefont icon-QQ"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://github.com/margrop/"
			target="_blank"
			mdui-tooltip="{content: 'GitHub'}"
			style="
				color: rgb(25, 23, 23);
				background-color: rgba(25, 23, 23, .1);
			"
		>
			<i
				class="nexmoefont icon-github"
			></i> </a
		><a
			class="mdui-ripple"
			href="../../atom.xml"
			target="_blank"
			mdui-tooltip="{content: 'RSS'}"
			style="
				color: rgb(247, 132, 34);
				background-color: rgba(247, 132, 34, .1);
			"
		>
			<i
				class="nexmoefont icon-rss"
			></i> </a
		>
	</div>
</div>

    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Categories</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/Adblocker/">Adblocker</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/Android/">Android</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/CentOS/">CentOS</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/Container/">Container</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/Git/">Git</a>
          <span class="category-list-count">7</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/HomeAssistant/">HomeAssistant</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/MacOS/">MacOS</a>
          <span class="category-list-count">11</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/PVE/">PVE</a>
          <span class="category-list-count">19</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/SmartHome/">SmartHome</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/Synology/">Synology</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/Ubuntu/">Ubuntu</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/Windows/">Windows</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ai-diary/">ai_diary</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ai-tech/">ai_tech</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/develop/">develop</a>
          <span class="category-list-count">28</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/fuckgfw/">fuckgfw</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/n2n/">n2n</a>
          <span class="category-list-count">9</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/">network</a>
          <span class="category-list-count">112</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/notes/">notes</a>
          <span class="category-list-count">10</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/others/">others</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/router/">router</a>
          <span class="category-list-count">7</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/sport/">sport</a>
          <span class="category-list-count">4</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/network/tvbox/">tvbox</a>
          <span class="category-list-count">3</span>
        </li>

        
      </ul>

    </div>
  </div>


    
        
        
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="../../tags/1password/" style="font-size: 10px;">1password</a> <a href="../../tags/AC/" style="font-size: 10.91px;">AC</a> <a href="../../tags/AP/" style="font-size: 11.82px;">AP</a> <a href="../../tags/API/" style="font-size: 10px;">API</a> <a href="../../tags/AppDaemon/" style="font-size: 10px;">AppDaemon</a> <a href="../../tags/Aqara/" style="font-size: 10px;">Aqara</a> <a href="../../tags/Cron/" style="font-size: 10.91px;">Cron</a> <a href="../../tags/Date/" style="font-size: 10px;">Date</a> <a href="../../tags/Diagrams-net/" style="font-size: 10px;">Diagrams.net</a> <a href="../../tags/HA/" style="font-size: 10px;">HA</a> <a href="../../tags/HADashboard/" style="font-size: 10px;">HADashboard</a> <a href="../../tags/HomeAssistant/" style="font-size: 10px;">HomeAssistant</a> <a href="../../tags/IP/" style="font-size: 10px;">IP</a> <a href="../../tags/IPv4/" style="font-size: 10px;">IPv4</a> <a href="../../tags/Java/" style="font-size: 13.64px;">Java</a> <a href="../../tags/LVM%E2%80%91Thin/" style="font-size: 10.91px;">LVM‑Thin</a> <a href="../../tags/Linux/" style="font-size: 14.55px;">Linux</a> <a href="../../tags/MacOS/" style="font-size: 11.82px;">MacOS</a> <a href="../../tags/MiniMax/" style="font-size: 10px;">MiniMax</a> <a href="../../tags/MySQL/" style="font-size: 11.82px;">MySQL</a> <a href="../../tags/NAS/" style="font-size: 11.82px;">NAS</a> <a href="../../tags/OpenAI/" style="font-size: 10px;">OpenAI</a> <a href="../../tags/OpenResty/" style="font-size: 10px;">OpenResty</a> <a href="../../tags/PPPoE/" style="font-size: 10px;">PPPoE</a> <a href="../../tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="../../tags/ProcessOn/" style="font-size: 10px;">ProcessOn</a> <a href="../../tags/Proxmox-VE/" style="font-size: 20px;">Proxmox VE</a> <a href="../../tags/SSL/" style="font-size: 10px;">SSL</a> <a href="../../tags/Shell/" style="font-size: 10.91px;">Shell</a> <a href="../../tags/TTS/" style="font-size: 10px;">TTS</a> <a href="../../tags/TimeMachine/" style="font-size: 10px;">TimeMachine</a> <a href="../../tags/UML/" style="font-size: 10px;">UML</a> <a href="../../tags/Uptime-Kuma/" style="font-size: 10.91px;">Uptime Kuma</a> <a href="../../tags/Web/" style="font-size: 10px;">Web</a> <a href="../../tags/Windows/" style="font-size: 10px;">Windows</a> <a href="../../tags/activate/" style="font-size: 10.91px;">activate</a> <a href="../../tags/ad/" style="font-size: 10px;">ad</a> <a href="../../tags/adb/" style="font-size: 10px;">adb</a> <a href="../../tags/adblock/" style="font-size: 10.91px;">adblock</a> <a href="../../tags/agent/" style="font-size: 10px;">agent</a> <a href="../../tags/aligenie/" style="font-size: 10px;">aligenie</a> <a href="../../tags/aliyun/" style="font-size: 11.82px;">aliyun</a> <a href="../../tags/alpine/" style="font-size: 10px;">alpine</a> <a href="../../tags/annotation/" style="font-size: 10px;">annotation</a> <a href="../../tags/aop/" style="font-size: 10px;">aop</a> <a href="../../tags/authy/" style="font-size: 10px;">authy</a> <a href="../../tags/autofs/" style="font-size: 10px;">autofs</a> <a href="../../tags/backup/" style="font-size: 10px;">backup</a> <a href="../../tags/baidupan/" style="font-size: 10px;">baidupan</a> <a href="../../tags/bash/" style="font-size: 11.82px;">bash</a> <a href="../../tags/bitwarden/" style="font-size: 10px;">bitwarden</a> <a href="../../tags/boot/" style="font-size: 10.91px;">boot</a> <a href="../../tags/brew/" style="font-size: 10.91px;">brew</a> <a href="../../tags/browser/" style="font-size: 10px;">browser</a> <a href="../../tags/caddy2/" style="font-size: 10.91px;">caddy2</a> <a href="../../tags/cdn/" style="font-size: 10px;">cdn</a> <a href="../../tags/centos/" style="font-size: 19.09px;">centos</a> <a href="../../tags/cert/" style="font-size: 10.91px;">cert</a> <a href="../../tags/certbot/" style="font-size: 10px;">certbot</a> <a href="../../tags/charles/" style="font-size: 10px;">charles</a> <a href="../../tags/chat/" style="font-size: 10px;">chat</a> <a href="../../tags/chrome/" style="font-size: 11.82px;">chrome</a> <a href="../../tags/classloader/" style="font-size: 10px;">classloader</a> <a href="../../tags/client/" style="font-size: 11.82px;">client</a> <a href="../../tags/clone/" style="font-size: 10.91px;">clone</a> <a href="../../tags/closures/" style="font-size: 10px;">closures</a> <a href="../../tags/cloudflare/" style="font-size: 10.91px;">cloudflare</a> <a href="../../tags/cmd/" style="font-size: 10px;">cmd</a> <a href="../../tags/command/" style="font-size: 10px;">command</a> <a href="../../tags/commit/" style="font-size: 10px;">commit</a> <a href="../../tags/container/" style="font-size: 10px;">container</a> <a href="../../tags/crontab/" style="font-size: 10px;">crontab</a> <a href="../../tags/ctyun/" style="font-size: 10.91px;">ctyun</a> <a href="../../tags/ddsm/" style="font-size: 10px;">ddsm</a> <a href="../../tags/demo/" style="font-size: 10px;">demo</a> <a href="../../tags/dependency/" style="font-size: 10px;">dependency</a> <a href="../../tags/deploy/" style="font-size: 10px;">deploy</a> <a href="../../tags/developer/" style="font-size: 10px;">developer</a> <a href="../../tags/devtools/" style="font-size: 10px;">devtools</a> <a href="../../tags/dll/" style="font-size: 10px;">dll</a> <a href="../../tags/dns/" style="font-size: 11.82px;">dns</a> <a href="../../tags/docker/" style="font-size: 17.27px;">docker</a> <a href="../../tags/domain/" style="font-size: 10px;">domain</a> <a href="../../tags/download/" style="font-size: 10px;">download</a> <a href="../../tags/draw/" style="font-size: 10.91px;">draw</a> <a href="../../tags/drawio/" style="font-size: 10px;">drawio</a> <a href="../../tags/dsm/" style="font-size: 16.36px;">dsm</a> <a href="../../tags/dump/" style="font-size: 10px;">dump</a> <a href="../../tags/dylib/" style="font-size: 10px;">dylib</a> <a href="../../tags/edge/" style="font-size: 11.82px;">edge</a> <a href="../../tags/exception/" style="font-size: 10.91px;">exception</a> <a href="../../tags/export/" style="font-size: 10px;">export</a> <a href="../../tags/fail2ban/" style="font-size: 10px;">fail2ban</a> <a href="../../tags/feign/" style="font-size: 10px;">feign</a> <a href="../../tags/firewall-cmd/" style="font-size: 10.91px;">firewall-cmd</a> <a href="../../tags/flow/" style="font-size: 10px;">flow</a> <a href="../../tags/frp/" style="font-size: 10.91px;">frp</a> <a href="../../tags/frpc/" style="font-size: 12.73px;">frpc</a> <a href="../../tags/frps/" style="font-size: 10.91px;">frps</a> <a href="../../tags/fuckgfw/" style="font-size: 12.73px;">fuckgfw</a> <a href="../../tags/function/" style="font-size: 10px;">function</a> <a href="../../tags/gcc/" style="font-size: 10px;">gcc</a> <a href="../../tags/gfw/" style="font-size: 10.91px;">gfw</a> <a href="../../tags/git/" style="font-size: 14.55px;">git</a> <a href="../../tags/github/" style="font-size: 15.45px;">github</a> <a href="../../tags/golang/" style="font-size: 10px;">golang</a> <a href="../../tags/gperftools/" style="font-size: 10px;">gperftools</a> <a href="../../tags/gridea/" style="font-size: 10.91px;">gridea</a> <a href="../../tags/grub/" style="font-size: 10.91px;">grub</a> <a href="../../tags/gvt-g/" style="font-size: 10px;">gvt-g</a> <a href="../../tags/hacs/" style="font-size: 10px;">hacs</a> <a href="../../tags/havcs/" style="font-size: 10.91px;">havcs</a> <a href="../../tags/heap/" style="font-size: 10px;">heap</a> <a href="../../tags/hello/" style="font-size: 10.91px;">hello</a> <a href="../../tags/hexo/" style="font-size: 11.82px;">hexo</a> <a href="../../tags/hibernate/" style="font-size: 10.91px;">hibernate</a> <a href="../../tags/hidpi/" style="font-size: 10px;">hidpi</a> <a href="../../tags/hoisting/" style="font-size: 10px;">hoisting</a> <a href="../../tags/homeassistant/" style="font-size: 13.64px;">homeassistant</a> <a href="../../tags/hosts/" style="font-size: 10px;">hosts</a> <a href="../../tags/html/" style="font-size: 10.91px;">html</a> <a href="../../tags/htmlparser/" style="font-size: 10px;">htmlparser</a> <a href="../../tags/https/" style="font-size: 11.82px;">https</a> <a href="../../tags/idea/" style="font-size: 10px;">idea</a> <a href="../../tags/image/" style="font-size: 10px;">image</a> <a href="../../tags/img/" style="font-size: 10.91px;">img</a> <a href="../../tags/img2kvm/" style="font-size: 10px;">img2kvm</a> <a href="../../tags/import/" style="font-size: 10px;">import</a> <a href="../../tags/index/" style="font-size: 10px;">index</a> <a href="../../tags/install/" style="font-size: 14.55px;">install</a> <a href="../../tags/intel/" style="font-size: 10.91px;">intel</a> <a href="../../tags/io/" style="font-size: 10px;">io</a> <a href="../../tags/ios/" style="font-size: 10px;">ios</a> <a href="../../tags/ip/" style="font-size: 10px;">ip</a> <a href="../../tags/iptables/" style="font-size: 10px;">iptables</a> <a href="../../tags/iptv/" style="font-size: 10.91px;">iptv</a> <a href="../../tags/ipv6/" style="font-size: 10px;">ipv6</a> <a href="../../tags/iso/" style="font-size: 10px;">iso</a> <a href="../../tags/java/" style="font-size: 13.64px;">java</a> <a href="../../tags/javascript/" style="font-size: 10.91px;">javascript</a> <a href="../../tags/jetbrains/" style="font-size: 10px;">jetbrains</a> <a href="../../tags/jni/" style="font-size: 10px;">jni</a> <a href="../../tags/jnilib/" style="font-size: 10px;">jnilib</a> <a href="../../tags/jpa/" style="font-size: 10px;">jpa</a> <a href="../../tags/js/" style="font-size: 11.82px;">js</a> <a href="../../tags/json/" style="font-size: 10.91px;">json</a> <a href="../../tags/jsonb/" style="font-size: 10px;">jsonb</a> <a href="../../tags/jupter/" style="font-size: 10px;">jupter</a> <a href="../../tags/jupyterlab/" style="font-size: 10px;">jupyterlab</a> <a href="../../tags/jvm/" style="font-size: 10.91px;">jvm</a> <a href="../../tags/k8s/" style="font-size: 10.91px;">k8s</a> <a href="../../tags/kernel/" style="font-size: 10px;">kernel</a> <a href="../../tags/key/" style="font-size: 10px;">key</a> <a href="../../tags/kid/" style="font-size: 10px;">kid</a> <a href="../../tags/kms/" style="font-size: 10px;">kms</a> <a href="../../tags/kodi/" style="font-size: 10px;">kodi</a> <a href="../../tags/koolproxy/" style="font-size: 10.91px;">koolproxy</a> <a href="../../tags/koolproxyr/" style="font-size: 10.91px;">koolproxyr</a> <a href="../../tags/kvm/" style="font-size: 10.91px;">kvm</a> <a href="../../tags/lan/" style="font-size: 10px;">lan</a> <a href="../../tags/lastpass/" style="font-size: 10px;">lastpass</a> <a href="../../tags/launchctl/" style="font-size: 10px;">launchctl</a> <a href="../../tags/learning/" style="font-size: 10px;">learning</a> <a href="../../tags/lede/" style="font-size: 10px;">lede</a> <a href="../../tags/letsencrypt/" style="font-size: 11.82px;">letsencrypt</a> <a href="../../tags/linux/" style="font-size: 12.73px;">linux</a> <a href="../../tags/live/" style="font-size: 10px;">live</a> <a href="../../tags/low-code/" style="font-size: 10px;">low-code</a> <a href="../../tags/lvm/" style="font-size: 10px;">lvm</a> <a href="../../tags/lxc/" style="font-size: 10px;">lxc</a> <a href="../../tags/m3u8/" style="font-size: 10px;">m3u8</a> <a href="../../tags/mac/" style="font-size: 10.91px;">mac</a> <a href="../../tags/macos/" style="font-size: 10px;">macos</a> <a href="../../tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="../../tags/markdown/" style="font-size: 10px;">markdown</a> <a href="../../tags/maven/" style="font-size: 10.91px;">maven</a> <a href="../../tags/md5/" style="font-size: 10.91px;">md5</a> <a href="../../tags/microcode/" style="font-size: 10px;">microcode</a> <a href="../../tags/mirror/" style="font-size: 10.91px;">mirror</a> <a href="../../tags/modem/" style="font-size: 10px;">modem</a> <a href="../../tags/modules/" style="font-size: 10px;">modules</a> <a href="../../tags/monitor/" style="font-size: 10px;">monitor</a> <a href="../../tags/mount/" style="font-size: 10px;">mount</a> <a href="../../tags/mstsc/" style="font-size: 10px;">mstsc</a> <a href="../../tags/mysql/" style="font-size: 10px;">mysql</a> <a href="../../tags/n2n/" style="font-size: 16.36px;">n2n</a> <a href="../../tags/n5105/" style="font-size: 10px;">n5105</a> <a href="../../tags/nas/" style="font-size: 10px;">nas</a> <a href="../../tags/network/" style="font-size: 17.27px;">network</a> <a href="../../tags/nfs/" style="font-size: 10px;">nfs</a> <a href="../../tags/node/" style="font-size: 10.91px;">node</a> <a href="../../tags/node-red/" style="font-size: 10.91px;">node-red</a> <a href="../../tags/nodejs/" style="font-size: 12.73px;">nodejs</a> <a href="../../tags/nohup/" style="font-size: 10.91px;">nohup</a> <a href="../../tags/notepad/" style="font-size: 10px;">notepad++</a> <a href="../../tags/npm/" style="font-size: 13.64px;">npm</a> <a href="../../tags/nssm/" style="font-size: 10.91px;">nssm</a> <a href="../../tags/ntp/" style="font-size: 10px;">ntp</a> <a href="../../tags/oop/" style="font-size: 10px;">oop</a> <a href="../../tags/openfeign/" style="font-size: 10px;">openfeign</a> <a href="../../tags/openssl/" style="font-size: 10.91px;">openssl</a> <a href="../../tags/os/" style="font-size: 10px;">os</a> <a href="../../tags/otp/" style="font-size: 10px;">otp</a> <a href="../../tags/ovz/" style="font-size: 10px;">ovz</a> <a href="../../tags/packet-capture/" style="font-size: 10px;">packet capture</a> <a href="../../tags/pat/" style="font-size: 10px;">pat</a> <a href="../../tags/pdf/" style="font-size: 10px;">pdf</a> <a href="../../tags/pem/" style="font-size: 10.91px;">pem</a> <a href="../../tags/perf/" style="font-size: 10px;">perf</a> <a href="../../tags/ping/" style="font-size: 10px;">ping</a> <a href="../../tags/pip/" style="font-size: 10px;">pip</a> <a href="../../tags/plugin/" style="font-size: 10px;">plugin</a> <a href="../../tags/png/" style="font-size: 10px;">png</a> <a href="../../tags/powerbutton/" style="font-size: 10px;">powerbutton</a> <a href="../../tags/print/" style="font-size: 10px;">print</a> <a href="../../tags/pro/" style="font-size: 10px;">pro</a> <a href="../../tags/proxy/" style="font-size: 10.91px;">proxy</a> <a href="../../tags/pve/" style="font-size: 20px;">pve</a> <a href="../../tags/pvekclean/" style="font-size: 12.73px;">pvekclean</a> <a href="../../tags/python/" style="font-size: 18.18px;">python</a> <a href="../../tags/qcow2/" style="font-size: 10px;">qcow2</a> <a href="../../tags/qemu/" style="font-size: 10.91px;">qemu</a> <a href="../../tags/qemu-guest-agent/" style="font-size: 10px;">qemu-guest-agent</a> <a href="../../tags/rar/" style="font-size: 10px;">rar</a> <a href="../../tags/reboot/" style="font-size: 10px;">reboot</a> <a href="../../tags/reflog/" style="font-size: 10px;">reflog</a> <a href="../../tags/remote/" style="font-size: 10px;">remote</a> <a href="../../tags/remote-desktop/" style="font-size: 10.91px;">remote desktop</a> <a href="../../tags/renew/" style="font-size: 10px;">renew</a> <a href="../../tags/repo/" style="font-size: 10px;">repo</a> <a href="../../tags/resize/" style="font-size: 10px;">resize</a> <a href="../../tags/retina/" style="font-size: 10px;">retina</a> <a href="../../tags/root/" style="font-size: 10px;">root</a> <a href="../../tags/route/" style="font-size: 10px;">route</a> <a href="../../tags/router/" style="font-size: 10.91px;">router</a> <a href="../../tags/rule/" style="font-size: 10px;">rule</a> <a href="../../tags/rules/" style="font-size: 10px;">rules</a> <a href="../../tags/runtime/" style="font-size: 10px;">runtime</a> <a href="../../tags/safari/" style="font-size: 10px;">safari</a> <a href="../../tags/sata/" style="font-size: 10px;">sata</a> <a href="../../tags/scipy-notebook/" style="font-size: 10px;">scipy-notebook</a> <a href="../../tags/scoping/" style="font-size: 10px;">scoping</a> <a href="../../tags/scp/" style="font-size: 10px;">scp</a> <a href="../../tags/server/" style="font-size: 10.91px;">server</a> <a href="../../tags/slmgr/" style="font-size: 10px;">slmgr</a> <a href="../../tags/so/" style="font-size: 10px;">so</a> <a href="../../tags/socks/" style="font-size: 10px;">socks</a> <a href="../../tags/source/" style="font-size: 10px;">source</a> <a href="../../tags/spk/" style="font-size: 10px;">spk</a> <a href="../../tags/spring/" style="font-size: 12.73px;">spring</a> <a href="../../tags/springboot/" style="font-size: 14.55px;">springboot</a> <a href="../../tags/springfox/" style="font-size: 11.82px;">springfox</a> <a href="../../tags/ssh/" style="font-size: 13.64px;">ssh</a> <a href="../../tags/ssl/" style="font-size: 10.91px;">ssl</a> <a href="../../tags/stash/" style="font-size: 10px;">stash</a> <a href="../../tags/string/" style="font-size: 10px;">string</a> <a href="../../tags/supernode/" style="font-size: 10.91px;">supernode</a> <a href="../../tags/svg/" style="font-size: 10px;">svg</a> <a href="../../tags/svn/" style="font-size: 10px;">svn</a> <a href="../../tags/swagger/" style="font-size: 12.73px;">swagger</a> <a href="../../tags/sync/" style="font-size: 10px;">sync</a> <a href="../../tags/synology/" style="font-size: 10.91px;">synology</a> <a href="../../tags/systemctl/" style="font-size: 11.82px;">systemctl</a> <a href="../../tags/tap/" style="font-size: 10px;">tap</a> <a href="../../tags/tap-windows/" style="font-size: 10px;">tap-windows</a> <a href="../../tags/tapwindows/" style="font-size: 10px;">tapwindows</a> <a href="../../tags/telecom/" style="font-size: 10.91px;">telecom</a> <a href="../../tags/template/" style="font-size: 10px;">template</a> <a href="../../tags/terminal/" style="font-size: 10px;">terminal</a> <a href="../../tags/tls/" style="font-size: 10px;">tls</a> <a href="../../tags/token/" style="font-size: 10px;">token</a> <a href="../../tags/totp/" style="font-size: 10px;">totp</a> <a href="../../tags/tvbox/" style="font-size: 11.82px;">tvbox</a> <a href="../../tags/txt/" style="font-size: 10px;">txt</a> <a href="../../tags/ubuntu/" style="font-size: 13.64px;">ubuntu</a> <a href="../../tags/udisk/" style="font-size: 10px;">udisk</a> <a href="../../tags/ui/" style="font-size: 10px;">ui</a> <a href="../../tags/undertow/" style="font-size: 10px;">undertow</a> <a href="../../tags/uninstall/" style="font-size: 10px;">uninstall</a> <a href="../../tags/unlocker/" style="font-size: 10px;">unlocker</a> <a href="../../tags/upgrade/" style="font-size: 10.91px;">upgrade</a> <a href="../../tags/url/" style="font-size: 10px;">url</a> <a href="../../tags/v2ray/" style="font-size: 10.91px;">v2ray</a> <a href="../../tags/vhd/" style="font-size: 10px;">vhd</a> <a href="../../tags/vim/" style="font-size: 10px;">vim</a> <a href="../../tags/vlmcsd/" style="font-size: 10px;">vlmcsd</a> <a href="../../tags/vm/" style="font-size: 10.91px;">vm</a> <a href="../../tags/vmdk/" style="font-size: 10px;">vmdk</a> <a href="../../tags/web/" style="font-size: 13.64px;">web</a> <a href="../../tags/websocket/" style="font-size: 10.91px;">websocket</a> <a href="../../tags/wechat/" style="font-size: 10px;">wechat</a> <a href="../../tags/windows/" style="font-size: 13.64px;">windows</a> <a href="../../tags/with/" style="font-size: 10px;">with</a> <a href="../../tags/worker/" style="font-size: 10.91px;">worker</a> <a href="../../tags/wow/" style="font-size: 10px;">wow</a> <a href="../../tags/xiaoya/" style="font-size: 10px;">xiaoya</a> <a href="../../tags/xml/" style="font-size: 10px;">xml</a> <a href="../../tags/yum/" style="font-size: 10px;">yum</a> <a href="../../tags/zip/" style="font-size: 10px;">zip</a> <a href="../../tags/%E4%B8%AD%E5%9B%BD%E7%94%B5%E4%BF%A1/" style="font-size: 10px;">中国电信</a> <a href="../../tags/%E4%BA%91%E7%94%B5%E8%84%91/" style="font-size: 10.91px;">云电脑</a> <a href="../../tags/%E4%BA%A4%E6%8D%A2%E6%9C%BA/" style="font-size: 10px;">交换机</a> <a href="../../tags/%E5%85%89%E7%8C%AB/" style="font-size: 10.91px;">光猫</a> <a href="../../tags/%E5%85%AC%E7%BD%91IP/" style="font-size: 10px;">公网IP</a> <a href="../../tags/%E5%86%85%E5%AD%98/" style="font-size: 10px;">内存</a> <a href="../../tags/%E5%86%85%E7%BD%91IP/" style="font-size: 10px;">内网IP</a> <a href="../../tags/%E5%8D%87%E7%BA%A7/" style="font-size: 10.91px;">升级</a> <a href="../../tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 10px;">反向代理</a> <a href="../../tags/%E5%90%AF%E5%8A%A8/" style="font-size: 10px;">启动</a> <a href="../../tags/%E5%A4%8F%E4%BB%A4%E6%97%B6/" style="font-size: 10px;">夏令时</a> <a href="../../tags/%E5%A4%A9%E7%8C%AB%E7%B2%BE%E7%81%B5/" style="font-size: 10px;">天猫精灵</a> <a href="../../tags/%E5%A4%A9%E7%BF%BC%E4%BA%91/" style="font-size: 10.91px;">天翼云</a> <a href="../../tags/%E5%AE%89%E5%85%A8/" style="font-size: 10px;">安全</a> <a href="../../tags/%E5%AE%89%E8%A3%85/" style="font-size: 10.91px;">安装</a> <a href="../../tags/%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">容器</a> <a href="../../tags/%E5%AF%BC%E5%85%A5/" style="font-size: 10px;">导入</a> <a href="../../tags/%E5%B0%8F%E7%B1%B3/" style="font-size: 10px;">小米</a> <a href="../../tags/%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/" style="font-size: 10px;">常用软件</a> <a href="../../tags/%E5%B9%BF%E5%91%8A%E5%B1%8F%E8%94%BD/" style="font-size: 10px;">广告屏蔽</a> <a href="../../tags/%E5%BA%8F%E5%88%97%E5%8F%B7/" style="font-size: 10px;">序列号</a> <a href="../../tags/%E5%BA%94%E7%94%A8%E5%B8%82%E5%9C%BA/" style="font-size: 10px;">应用市场</a> <a href="../../tags/%E5%BC%82%E5%B8%B8/" style="font-size: 10px;">异常</a> <a href="../../tags/%E6%89%93%E5%B7%A5/" style="font-size: 10.91px;">打工</a> <a href="../../tags/%E6%8A%80%E6%9C%AF/" style="font-size: 12.73px;">技术</a> <a href="../../tags/%E6%8A%93%E5%8C%85/" style="font-size: 10px;">抓包</a> <a href="../../tags/%E6%8F%8F%E8%BF%B0%E6%96%87%E4%BB%B6/" style="font-size: 10px;">描述文件</a> <a href="../../tags/%E6%97%A5%E8%AE%B0/" style="font-size: 11.82px;">日记</a> <a href="../../tags/%E6%97%B6%E5%8C%BA/" style="font-size: 10px;">时区</a> <a href="../../tags/%E6%98%BE%E5%8D%A1%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 10px;">显卡虚拟化</a> <a href="../../tags/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/" style="font-size: 10px;">智能家居</a> <a href="../../tags/%E6%99%BA%E8%83%BD%E9%9F%B3%E7%AE%B1/" style="font-size: 10px;">智能音箱</a> <a href="../../tags/%E6%A2%AF%E5%AD%90/" style="font-size: 10px;">梯子</a> <a href="../../tags/%E6%A8%A1%E5%9D%97/" style="font-size: 10px;">模块</a> <a href="../../tags/%E6%B5%81%E7%A8%8B/" style="font-size: 10px;">流程</a> <a href="../../tags/%E6%B5%81%E7%A8%8B%E5%9B%BE/" style="font-size: 10px;">流程图</a> <a href="../../tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 10.91px;">浏览器</a> <a href="../../tags/%E6%BC%AB%E6%B8%B8/" style="font-size: 10px;">漫游</a> <a href="../../tags/%E6%BF%80%E6%B4%BB/" style="font-size: 10px;">激活</a> <a href="../../tags/%E7%81%AB%E7%BB%92/" style="font-size: 10px;">火绒</a> <a href="../../tags/%E7%94%B5%E4%BF%A1/" style="font-size: 10.91px;">电信</a> <a href="../../tags/%E7%94%BB%E5%9B%BE/" style="font-size: 10px;">画图</a> <a href="../../tags/%E7%9B%B4%E6%92%AD%E6%BA%90/" style="font-size: 10px;">直播源</a> <a href="../../tags/%E7%BB%AD%E6%9C%9F/" style="font-size: 10px;">续期</a> <a href="../../tags/%E7%BD%91%E5%85%B3/" style="font-size: 10px;">网关</a> <a href="../../tags/%E7%BD%91%E7%BB%9C%E9%A3%8E%E6%9A%B4/" style="font-size: 10px;">网络风暴</a> <a href="../../tags/%E7%BE%A4%E6%99%96/" style="font-size: 10.91px;">群晖</a> <a href="../../tags/%E8%85%BE%E8%AE%AF/" style="font-size: 10px;">腾讯</a> <a href="../../tags/%E8%87%AA%E5%8A%A8%E5%8C%96/" style="font-size: 10px;">自动化</a> <a href="../../tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 11.82px;">虚拟机</a> <a href="../../tags/%E8%AE%A4%E8%AF%81/" style="font-size: 10px;">认证</a> <a href="../../tags/%E8%AF%81%E4%B9%A6/" style="font-size: 10px;">证书</a> <a href="../../tags/%E8%B7%AF%E7%94%B1/" style="font-size: 10px;">路由</a> <a href="../../tags/%E8%B7%AF%E7%94%B1%E5%99%A8/" style="font-size: 10px;">路由器</a> <a href="../../tags/%E8%BD%AF%E4%BB%B6%E7%AE%A1%E5%AE%B6/" style="font-size: 10px;">软件管家</a> <a href="../../tags/%E8%BD%AF%E8%B7%AF%E7%94%B1/" style="font-size: 10.91px;">软路由</a> <a href="../../tags/%E8%BF%90%E7%BB%B4/" style="font-size: 13.64px;">运维</a> <a href="../../tags/%E8%BF%90%E7%BB%B4%E7%9B%91%E6%8E%A7/" style="font-size: 10.91px;">运维监控</a> <a href="../../tags/%E9%95%9C%E5%83%8F/" style="font-size: 11.82px;">镜像</a> <a href="../../tags/%E9%95%9C%E5%83%8F%E6%BA%90/" style="font-size: 10px;">镜像源</a> <a href="../../tags/%E9%97%A8%E7%AA%97%E4%BC%A0%E6%84%9F%E5%99%A8/" style="font-size: 10px;">门窗传感器</a> <a href="../../tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" style="font-size: 10.91px;">问题排查</a> <a href="../../tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 10px;">防火墙</a> <a href="../../tags/%E9%98%BF%E9%87%8C%E4%BA%91/" style="font-size: 12.73px;">阿里云</a> <a href="../../tags/%E9%98%BF%E9%87%8C%E6%BA%90/" style="font-size: 10.91px;">阿里源</a> <a href="../../tags/%E9%9B%86%E5%AE%A2/" style="font-size: 10.91px;">集客</a>
    </div>
    
      <script>
        var maxTagcloud = parseInt(17);
        var tags_length = parseInt(365);
        var tags_arr = [];
        for(var i = 0; i < tags_length; i++){
          tags_arr.push(i);
        }
        tags_arr.sort(function (l, r) {
          return Math.random() > 0.5 ? -1 : 1;
        });
        tags_arr = tags_arr.slice(0, maxTagcloud < tags_length ? tags_length - maxTagcloud : 0);
        for(var tag_i = 0; tag_i < tags_arr.length; tag_i++){
          document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display = 'none';
        }
      </script>
    
  </div>

    
        
        <!-- 一言 -->
<div class="nexmoe-widget-wrap">
  <h3 class="nexmoe-widget-title">
    Hitokoto
  </h3>
  <div class="nexmoe-widget">
    <ul class="hitokoto-box">
      <li id="hitokoto_text_parent" class="hitokoto-text" hitokotoCategory="">
        <a href="#" id="hitokoto_text">
          
        </a>
        <a href="#" id="hitokoto_error_text" style="display: none;">
          
        </a>
      </li>
    </ul>
  </div>
</div>

<script>
  let hitokotoText = document.getElementById('hitokoto_text')
  let hitokotoErroText = document.getElementById('hitokoto_error_text')
  let hitokotoCategory = document.getElementById('hitokoto_text_parent').getAttribute('hitokotoCategory')
  window.addEventListener('load', function () {
    let url = 'https://v1.hitokoto.cn'
    if (hitokotoCategory) {
      url += '?c=' + hitokotoCategory
    }
    fetch(url)
      .then(response => response.json())
      .then(data => {
        hitokotoText.innerText = "「 " + data.hitokoto + " 」 from " + data.from
        hitokotoText.href = 'https://hitokoto.cn/?uuid=' + data.uuid
      })
      .catch((reason) => {
        console.error(11, reason)
        hitokotoText.style.display = 'none'
        hitokotoErroText.style.display = 'block'
      })
  })
</script>
    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Archive</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2026/">2026</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2025/">2025</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2024/">2024</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2023/">2023</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2022/">2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2021/">2021</a><span class="archive-list-count">114</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/">2018</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>



    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Recent Posts</h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="../../post/2026-02-28-openresty-signed-cookie-auth-gateway/">使用 OpenResty + 签名 Cookie 实现登录一次即可长时间免认证的反代安全网关</a>
          </li>
        
          <li>
            <a href="../../post/2026-02-27-how-to-use-minimax-to-maintain-openclaw/">如何使用 MiniMax API 搭建自动化运维助手——我的 OpenClaw 实践之路</a>
          </li>
        
          <li>
            <a href="../../post/2026-02-27-troubleshooting-connection-refused/">记一次排查服务连接&#34;被拒绝&#34;问题的完整流程</a>
          </li>
        
          <li>
            <a href="../../post/2026-02-27-bug-fixed-tomorrow-awaiting/">今天的bug终于修完了，然而明天还有新的bug在等着我</a>
          </li>
        
          <li>
            <a href="../../post/2026-02-26-troubleshooting-chatbot-connection/">记一次排查消息通道连接失败的实战经历</a>
          </li>
        
      </ul>
    </div>
  </div>

    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-link">
		<ul>
        
            <li>
                <a href="https://blog.margrop.net/" target="_blank" >
                    <img src="/images/avatar.webp" alt="魔都水滴Blog"></img>
                    <p>魔都水滴Blog</p>
                </a>
            </li>
        
		</ul>
    </div>
</div>
<style>
.nexmoe-widget-wrap .nexmoe-link ul li a {
    text-align : center;
}
.nexmoe-widget-wrap .nexmoe-link ul li a img {
    max-width : 100%;
}
.nexmoe-widget-wrap .nexmoe-link ul li a p {
    margin: 10px 0;
}
</style>

    
   
    <div class="nexmoe-copyright">
        &copy; 2026 Margrop
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer --></div><div id="nexmoe-content"><div class="nexmoe-primary"><div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover absolute" style="padding-top: 56.25%;"> 
            <img src="https://picsum.photos/seed/20260228auth/1280/720" alt="使用 OpenResty + 签名 Cookie 实现登录一次即可长时间免认证的反代安全网关" loading="lazy">
            <h1>使用 OpenResty + 签名 Cookie 实现登录一次即可长时间免认证的反代安全网关</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2026年02月28日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="../../categories/ai-tech/">ai_tech</a>
        
        
    <a><i class="nexmoefont icon-areachart"></i>约23k字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要33 分钟</a>

    </div>
    
    
    
    
    
</div>

    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在日常运维工作中，我们经常需要暴露一些 Web 面板或管理后台到公网，方便随时随地访问。然而，公网暴露端口容易被扫描和爆破，给系统带来安全隐患。最近各类 Web 应用的安全事件频发，如何在不修改原应用的情况下，为这些服务增加一层安全防护，成为了一个值得思考的问题。</p>
<p>本文将介绍一种轻量级的加固方案：使用 OpenResty 搭建反向代理网关，通过 BasicAuth 进行首次认证，结合签名 Cookie 实现 1 小时免重复认证。整个方案不需要修改原应用容器，不依赖 Redis 或数据库，完全无状态。</p>
<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>很多常见的 Web 面板和管理后台都存在以下问题：</p>
<h3 id="1-端口直接暴露"><a href="#1-端口直接暴露" class="headerlink" title="1. 端口直接暴露"></a>1. 端口直接暴露</h3><p>很多应用默认监听所有网络接口，导致端口直接暴露在公网。这意味着任何人都可以尝试访问你的服务，增加了被攻击的风险。</p>
<h3 id="2-弱密码风险"><a href="#2-弱密码风险" class="headerlink" title="2. 弱密码风险"></a>2. 弱密码风险</h3><p>有些应用的默认账号密码非常简单，或者用户设置的密码强度不够，很容易被暴力破解。</p>
<h3 id="3-频繁验证繁琐"><a href="#3-频繁验证繁琐" class="headerlink" title="3. 频繁验证繁琐"></a>3. 频繁验证繁琐</h3><p>如果每次访问都需要输入密码验证，会严重影响使用体验。特别是对于需要频繁访问的管理后台来说，重复认证非常麻烦。</p>
<h3 id="4-改造成本高"><a href="#4-改造成本高" class="headerlink" title="4. 改造成本高"></a>4. 改造成本高</h3><p>对原应用进行安全改造需要投入大量时间和精力，而且可能会引入新的问题。</p>
<h2 id="解决方案概述"><a href="#解决方案概述" class="headerlink" title="解决方案概述"></a>解决方案概述</h2><p>针对以上问题，我设计了一套基于 OpenResty 的反向代理认证网关方案。这套方案的核心思想是：在不改原应用的情况下，通过网关层实现统一的认证控制。</p>
<h3 id="方案特点"><a href="#方案特点" class="headerlink" title="方案特点"></a>方案特点</h3><ul>
<li><strong>不改原应用</strong>：所有认证逻辑都在网关层实现，不需要修改任何应用代码</li>
<li><strong>首次 BasicAuth</strong>：首次访问时弹出认证对话框，输入正确的用户名密码后即可进入</li>
<li><strong>签名 Cookie</strong>：认证成功后生成带有签名的 Cookie，有效期内无需重复认证</li>
<li><strong>无状态设计</strong>：不依赖任何外部存储（Redis、数据库等），容器重启不影响认证状态</li>
<li><strong>支持 WebSocket</strong>：完整支持 WebSocket 连接，可以用于各类实时应用</li>
</ul>
<h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h3><p>为什么选择 OpenResty？主要有以下考虑：</p>
<ol>
<li><strong>高性能</strong>：基于 Nginx，性能出色</li>
<li><strong>Lua 支持</strong>：内置 Lua 支持，可以灵活实现各种逻辑</li>
<li><strong>模块丰富</strong>：社区提供了大量实用的模块</li>
<li><strong>易于部署</strong>：官方提供 Alpine 镜像，体积小巧</li>
</ol>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><h3 id="网络架构"><a href="#网络架构" class="headerlink" title="网络架构"></a>网络架构</h3><p>整体架构可以分为三层：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">公网入口 → OpenResty 网关 → 内部应用<br></code></pre></td></tr></table></figure>

<p>具体流程如下：</p>
<ol>
<li>用户访问公网地址</li>
<li>请求首先到达 OpenResty 网关</li>
<li>网关检查是否存在有效的签名 Cookie</li>
<li>如果没有 Cookie 或 Cookie 已过期，跳转到登录页面</li>
<li>用户在登录页面完成 BasicAuth 认证</li>
<li>认证成功后，网关生成签名 Cookie 并跳转到目标页面</li>
<li>之后 1 小时内访问同一页面无需再次认证</li>
</ol>
<h3 id="组件说明"><a href="#组件说明" class="headerlink" title="组件说明"></a>组件说明</h3><p>整个方案包含两个核心组件：</p>
<p><strong>内部应用容器</strong>：这是你需要保护的服务，比如某管理面板。它只监听容器内部端口 127.0.0.1，不直接暴露到公网。</p>
<p><strong>OpenResty 网关</strong>：反向代理服务器，负责所有外部请求的接入、认证检查和 Cookie 签名验证。</p>
<h2 id="核心实现"><a href="#核心实现" class="headerlink" title="核心实现"></a>核心实现</h2><h3 id="Docker-Compose-配置"><a href="#Docker-Compose-配置" class="headerlink" title="Docker Compose 配置"></a>Docker Compose 配置</h3><p>首先来看完整的 Docker Compose 配置文件。这个文件定义了内部应用和 OpenResty 网关两个服务。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">app:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">your-app-image:tag</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">app</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;127.0.0.1:内部端口:内部端口&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ql_net</span><br><br>  <span class="hljs-attr">openresty:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">openresty/openresty:alpine</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">secure-gateway</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">app</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;外网端口:80&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">COOKIE_SECRET:</span> <span class="hljs-string">&quot;your_long_random_secret&quot;</span><br>      <span class="hljs-attr">COOKIE_NAME:</span> <span class="hljs-string">&quot;ql_auth&quot;</span><br>      <span class="hljs-attr">COOKIE_TTL:</span> <span class="hljs-string">&quot;3600&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./.htpasswd:/etc/openresty/.htpasswd:ro</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ql_net</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">ql_net:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span><br></code></pre></td></tr></table></figure>

<p>关键点说明：</p>
<ul>
<li>内部应用端口绑定到 127.0.0.1，确保只能从容器内部访问</li>
<li>OpenResty 通过环境变量配置 Cookie 签名密钥、名称和过期时间</li>
<li>使用 Docker 内置 DNS 实现容器名解析</li>
</ul>
<h3 id="Nginx-配置详解"><a href="#Nginx-配置详解" class="headerlink" title="Nginx 配置详解"></a>Nginx 配置详解</h3><p>接下来是核心的 Nginx 配置文件。这个配置实现了完整的认证流程。</p>
<h4 id="1-HTTP-和事件配置"><a href="#1-HTTP-和事件配置" class="headerlink" title="1. HTTP 和事件配置"></a>1. HTTP 和事件配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">worker_processes</span> <span class="hljs-number">1</span>;<br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span> <span class="hljs-number">1024</span>;<br>&#125;<br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span> mime.types;<br>    <span class="hljs-attribute">default_type</span> application/octet-stream;<br>    <span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">keepalive_timeout</span> <span class="hljs-number">65</span>;<br>    <br>    <span class="hljs-comment"># Docker 内置 DNS</span><br>    <span class="hljs-attribute">resolver</span> <span class="hljs-number">127.0.0.11</span> ipv6=<span class="hljs-literal">off</span> valid=<span class="hljs-number">30s</span>;<br>    <br>    <span class="hljs-comment"># WebSocket 支持</span><br>    <span class="hljs-attribute">map</span> <span class="hljs-variable">$http_upgrade</span> <span class="hljs-variable">$connection_upgrade</span> &#123;<br>        <span class="hljs-attribute">default</span> upgrade;<br>        &#x27;&#x27; close;<br>    &#125;<br>    <span class="hljs-comment"># 省略部分配置...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里使用了 Docker 内置的 DNS 解析器，可以根据容器名自动解析 IP 地址。WebSocket 的支持通过 map 指令实现 Connection 头的转换。</p>
<h4 id="2-登录入口实现"><a href="#2-登录入口实现" class="headerlink" title="2. 登录入口实现"></a>2. 登录入口实现</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> = /__login &#123;<br>    <span class="hljs-attribute">auth_basic</span> <span class="hljs-string">&quot;Restricted&quot;</span>;<br>    <span class="hljs-attribute">auth_basic_user_file</span> /etc/openresty/.htpasswd;<br>    <br>    <span class="hljs-section">content_by_lua_block</span> &#123;<br>        <span class="hljs-attribute">local</span> secret = os.getenv(<span class="hljs-string">&quot;COOKIE_SECRET&quot;</span>)<br>        local cookie_name = os.getenv(<span class="hljs-string">&quot;COOKIE_NAME&quot;</span>)<br>        local ttl = tonumber(os.getenv(<span class="hljs-string">&quot;COOKIE_TTL&quot;</span>))<br>        <br>        -- HMAC-SHA1 签名<br>        local function sign(payload)<br>            return to_hex(ngx.hmac_sha1(secret, payload))<br>        end<br>        <br>        -- 生成过期时间戳<br>        local exp = ngx.time() + ttl<br>        local payload = tostring(exp)<br>        <br>        -- 生成签名 Cookie<br>        local token = payload .. <span class="hljs-string">&quot;.&quot;</span> .. sign(payload)<br>        <br>        -- 设置 Cookie 头<br>        ngx.header[<span class="hljs-string">&quot;Set-Cookie&quot;</span>] = cookie_name .. <span class="hljs-string">&quot;=&quot;</span> .. token .. <br>            <span class="hljs-string">&quot;; Path=/; Max-Age=&quot;</span> .. ttl .. <br>            <span class="hljs-string">&quot;; HttpOnly; SameSite=Lax&quot;</span><br>        <br>        -- 登录成功后跳转<br>        return ngx.<span class="hljs-literal">redirect</span>(ngx.var.arg_next or <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-number">302</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>登录入口的特点：</p>
<ul>
<li>只在 &#x2F;__login 路径触发 BasicAuth 认证</li>
<li>使用 HMAC-SHA1 算法对过期时间戳进行签名</li>
<li>Cookie 设置为 HttpOnly，防止 JavaScript 读取</li>
<li>使用 SameSite&#x3D;Lax 减少 CSRF 风险</li>
</ul>
<h4 id="3-主入口验证逻辑"><a href="#3-主入口验证逻辑" class="headerlink" title="3. 主入口验证逻辑"></a>3. 主入口验证逻辑</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> / &#123;<br>    <span class="hljs-section">access_by_lua_block</span> &#123;<br>        -- 校验签名 <span class="hljs-attribute">Cookie</span><br>        local token = ngx.var[<span class="hljs-string">&quot;cookie_ql_auth&quot;</span>]<br>        <br>        if token then<br>            local dot = token:find(<span class="hljs-string">&quot;%.&quot;</span>)<br>            local payload = token:sub(<span class="hljs-number">1</span>, dot - <span class="hljs-number">1</span>)<br>            local sig = token:sub(dot + <span class="hljs-number">1</span>)<br>            <br>            -- 验签并检查过期<br>            if sig == sign(payload) then<br>                local exp = tonumber(payload)<br>                if exp and exp &gt; ngx.time() then<br>                    ok = <span class="hljs-literal">true</span><br>                end<br>            end<br>        end<br>        <br>        -- 未通过验证则跳转登录<br>        if not ok then<br>            return ngx.<span class="hljs-literal">redirect</span>(<span class="hljs-string">&quot;/__login?next=&quot;</span> .. ngx.escape_uri(request_uri), <span class="hljs-number">302</span>)<br>        end<br>    &#125;<br>    <br>    -- 反向代理到内部应用<br>    proxy_pass http://app:内部端口;<br>    <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;<br>    <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;<br>    <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>    <span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>    <br>    -- <span class="hljs-attribute">WebSocket</span> 支持<br>    proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;<br>    <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-variable">$connection_upgrade</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主入口的验证流程：</p>
<ol>
<li>读取请求中的 Cookie</li>
<li>解析出 payload（过期时间戳）和 signature（签名）</li>
<li>使用相同的密钥重新计算签名并比对</li>
<li>检查当前时间是否超过过期时间</li>
<li>验证通过后允许访问，否则跳转到登录页</li>
</ol>
<h4 id="4-退出登录（可选）"><a href="#4-退出登录（可选）" class="headerlink" title="4. 退出登录（可选）"></a>4. 退出登录（可选）</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> = /__logout &#123;<br>    <span class="hljs-section">content_by_lua_block</span> &#123;<br>        -- 清除 <span class="hljs-attribute">Cookie</span><br>        ngx.header[<span class="hljs-string">&quot;Set-Cookie&quot;</span>] = <span class="hljs-string">&quot;ql_auth=deleted; Path=/; Max-Age=0&quot;</span><br>        return ngx.<span class="hljs-literal">redirect</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-number">302</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h2><h3 id="第一步：准备目录结构"><a href="#第一步：准备目录结构" class="headerlink" title="第一步：准备目录结构"></a>第一步：准备目录结构</h3><p>首先创建所需的目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /docker/yourapp/openresty<br><span class="hljs-built_in">mkdir</span> -p /docker/yourapp/data<br></code></pre></td></tr></table></figure>

<h3 id="第二步：生成认证文件"><a href="#第二步：生成认证文件" class="headerlink" title="第二步：生成认证文件"></a>第二步：生成认证文件</h3><p>使用 Apache 的 htpasswd 工具生成 BasicAuth 所需的账号密码文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run --<span class="hljs-built_in">rm</span> httpd:2.4-alpine \<br>    htpasswd -nbB username <span class="hljs-string">&#x27;strong_password&#x27;</span> \<br>    &gt; /docker/yourapp/openresty/.htpasswd<br></code></pre></td></tr></table></figure>

<h3 id="第三步：生成-Cookie-签名密钥"><a href="#第三步：生成-Cookie-签名密钥" class="headerlink" title="第三步：生成 Cookie 签名密钥"></a>第三步：生成 Cookie 签名密钥</h3><p>使用 Python 生成一个随机的长字符串作为签名密钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 -c <span class="hljs-string">&quot;import base64; print(base64.b64encode(__import__(&#x27;os&#x27;).urandom(48)).decode())&quot;</span><br></code></pre></td></tr></table></figure>

<p>将生成的密钥填入 docker-compose.yml 的 COOKIE_SECRET 环境变量。</p>
<h3 id="第四步：编写配置文件"><a href="#第四步：编写配置文件" class="headerlink" title="第四步：编写配置文件"></a>第四步：编写配置文件</h3><p>将前面介绍的 nginx.conf 和 docker-compose.yml 文件写入对应目录。</p>
<h3 id="第五步：启动服务"><a href="#第五步：启动服务" class="headerlink" title="第五步：启动服务"></a>第五步：启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /docker/yourapp<br>docker compose up -d<br></code></pre></td></tr></table></figure>

<h3 id="第六步：验证效果"><a href="#第六步：验证效果" class="headerlink" title="第六步：验证效果"></a>第六步：验证效果</h3><ol>
<li>首次访问：浏览器自动跳转到 &#x2F;__login 页面</li>
<li>弹出 BasicAuth 对话框，输入账号密码</li>
<li>认证成功后自动跳转到目标页面</li>
<li>在 1 小时内刷新页面，无需再次认证</li>
<li>访问 &#x2F;__logout 可以立即退出登录</li>
</ol>
<h2 id="常见错误排查"><a href="#常见错误排查" class="headerlink" title="常见错误排查"></a>常见错误排查</h2><h3 id="错误一：map-指令位置错误"><a href="#错误一：map-指令位置错误" class="headerlink" title="错误一：map 指令位置错误"></a>错误一：map 指令位置错误</h3><p>错误信息：map directive is not allowed here</p>
<p>原因：map 指令放在了 server 块内部，而不是 http 块级别。</p>
<p>解决：将 map 指令移到 http {} 块内部。</p>
<h3 id="错误二：缺少-HMAC-模块"><a href="#错误二：缺少-HMAC-模块" class="headerlink" title="错误二：缺少 HMAC 模块"></a>错误二：缺少 HMAC 模块</h3><p>错误信息：module ‘resty.hmac’ not found</p>
<p>原因：使用了第三方 HMAC 模块，但镜像中没有安装。</p>
<p>解决：使用 OpenResty 内置的 ngx.hmac_sha1() 函数，无需额外模块。</p>
<h3 id="错误三：Cookie-签名验证失败"><a href="#错误三：Cookie-签名验证失败" class="headerlink" title="错误三：Cookie 签名验证失败"></a>错误三：Cookie 签名验证失败</h3><p>可能原因：</p>
<ul>
<li>COOKIE_SECRET 不一致（多实例环境）</li>
<li>Cookie 被篡改</li>
<li>时间不同步</li>
</ul>
<p>解决：确保所有网关使用相同的签名密钥，检查服务器时间是否准确。</p>
<h2 id="安全建议"><a href="#安全建议" class="headerlink" title="安全建议"></a>安全建议</h2><p>虽然这套方案可以显著提升安全性，但仍有一些最佳实践需要注意：</p>
<h3 id="1-限制来源-IP"><a href="#1-限制来源-IP" class="headerlink" title="1. 限制来源 IP"></a>1. 限制来源 IP</h3><p>在云平台的安全组中，只放行你自己的公网 IP 地址。这是最有效的防护手段。</p>
<h3 id="2-修改登录路径"><a href="#2-修改登录路径" class="headerlink" title="2. 修改登录路径"></a>2. 修改登录路径</h3><p>将默认的 &#x2F;__login 路径改为随机的长路径，降低被扫描命中的概率。</p>
<h3 id="3-配置访问限流"><a href="#3-配置访问限流" class="headerlink" title="3. 配置访问限流"></a>3. 配置访问限流</h3><p>配置 Nginx 的限流规则，防止暴力破解。</p>
<h3 id="4-启用-HTTPS"><a href="#4-启用-HTTPS" class="headerlink" title="4. 启用 HTTPS"></a>4. 启用 HTTPS</h3><p>生产环境建议启用 HTTPS，确保所有通信都经过加密。BasicAuth 的账号密码和签名的 Cookie 都不应该明文传输。</p>
<h3 id="5-定期更换密钥"><a href="#5-定期更换密钥" class="headerlink" title="5. 定期更换密钥"></a>5. 定期更换密钥</h3><p>定期更换 COOKIE_SECRET，可以进一步提升安全性。换密钥后所有已登录用户需要重新认证。</p>
<h2 id="性能考量"><a href="#性能考量" class="headerlink" title="性能考量"></a>性能考量</h2><h3 id="1-Cookie-验证开销"><a href="#1-Cookie-验证开销" class="headerlink" title="1. Cookie 验证开销"></a>1. Cookie 验证开销</h3><p>Cookie 验证过程涉及 HMAC-SHA1 计算，对于现代 CPU 来说这个开销可以忽略不计。每秒处理数万请求毫无压力。</p>
<h3 id="2-内存占用"><a href="#2-内存占用" class="headerlink" title="2. 内存占用"></a>2. 内存占用</h3><p>OpenResty 的内存占用非常低， Alpine 镜像只有几十 MB。Lua 脚本的内存占用也很小。</p>
<h3 id="3-连接复用"><a href="#3-连接复用" class="headerlink" title="3. 连接复用"></a>3. 连接复用</h3><p>配置了 keepalive_timeout，可以复用与后端应用的连接，减少连接建立的开销。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>这套方案适合以下场景：</p>
<ul>
<li>各类需要认证的 Web 管理面板</li>
<li>需要临时暴露给特定人员的内部系统</li>
<li>开发测试环境的快速安全加固</li>
<li>不想修改原应用的任何代码的情况</li>
</ul>
<p>不适合以下场景：</p>
<ul>
<li>对安全性要求极高的金融系统</li>
<li>需要细粒度权限控制的应用</li>
<li>需要记录详细审计日志的场景</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这套基于 OpenResty 和签名 Cookie 的认证网关方案，具有以下优势：</p>
<ol>
<li><strong>轻量级</strong>：不需要额外的认证服务，不依赖数据库</li>
<li><strong>无状态</strong>：认证信息存储在客户端 Cookie 中，服务器不需要保存会话</li>
<li><strong>高安全</strong>：使用 HMAC-SHA1 签名防止 Cookie 篡改</li>
<li><strong>易部署</strong>：完全通过配置文件实现，不需要编写代码</li>
<li><strong>灵活可控</strong>：Cookie 过期时间可随意设置</li>
</ol>
<p>通过这套方案，我们可以快速将暴露在公网的各类 Web 面板从”裸奔”状态提升到”可控暴露”状态，既保证了安全性，又不影响使用体验。</p>
<p>如果你也有类似的安全加固需求，不妨试试这个方案。</p>
<hr>
<h2 id="🎁-MiniMax-跨年福利来袭！"><a href="#🎁-MiniMax-跨年福利来袭！" class="headerlink" title="🎁 MiniMax 跨年福利来袭！"></a>🎁 MiniMax 跨年福利来袭！</h2><p>邀好友享 Coding Plan 双重好礼，助力开发体验！</p>
<ul>
<li>好友立享 <strong>9折</strong> 专属优惠 + Builder 权益</li>
<li>你赢返利 + 社区特权</li>
</ul>
<p>👉 立即参与：<a target="_blank" rel="noopener" href="https://platform.minimaxi.com/subscribe/coding-plan?code=8Ah4UZHvZ0&source=link">https://platform.minimaxi.com/subscribe/coding-plan?code=8Ah4UZHvZ0&amp;source=link</a></p>

    
  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>Author：</strong>Margrop<br>
        <strong>Link：</strong><a href="http://blog.margrop.com/post/2026-02-28-openresty-signed-cookie-auth-gateway/" title="http:&#x2F;&#x2F;blog.margrop.com&#x2F;post&#x2F;2026-02-28-openresty-signed-cookie-auth-gateway&#x2F;" target="_blank" rel="noopener">http:&#x2F;&#x2F;blog.margrop.com&#x2F;post&#x2F;2026-02-28-openresty-signed-cookie-auth-gateway&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="../../tags/OpenResty/" rel="tag">OpenResty</a> <a class="nexmoefont icon-tag-fill -none-link" href="../../tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" rel="tag">反向代理</a> <a class="nexmoefont icon-tag-fill -none-link" href="../../tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a> <a class="nexmoefont icon-tag-fill -none-link" href="../../tags/%E6%8A%80%E6%9C%AF/" rel="tag">技术</a> <a class="nexmoefont icon-tag-fill -none-link" href="../../tags/%E8%AE%A4%E8%AF%81/" rel="tag">认证</a>
    
</div>
  
  
    <script async src="../../js/copy-codeblock.js?v=1772273952419"></script>
  

  
      <div class="nexmoe-post-footer">
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script>
  const gitalk = new Gitalk({
    clientID: 'Ov23lib2oiNKjG5B7I1N',
    clientSecret: '0a94653f17a7b9630d85b275008da4b38e0259dd',
    repo: 'margropcomment.margrop.io',      // The repository of store comments,
    owner: 'margrop',
    admin: ['margrop'],
    pagerDirection: 'last',
    id: window.location.pathname.substring(0, 49), // 使用 pathname 的前49个字符作为 id
    title: document.title,
    language: 'zh-CN', // 根据需要设置语言
    distractionFreeMode: false
  })
  gitalk.render('gitalk-container')
</script>

      </div>
  
</div></div><div class="nexmoe-post-right">    <div class="nexmoe-fixed">
        <div class="nexmoe-tool">

            

            
            
            <button class="mdui-fab catalog" style="overflow:unset;">
                <i class="nexmoefont icon-i-catalog"></i>
                <div class="nexmoe-toc">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">问题背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AB%AF%E5%8F%A3%E7%9B%B4%E6%8E%A5%E6%9A%B4%E9%9C%B2"><span class="toc-number">2.1.</span> <span class="toc-text">1. 端口直接暴露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BC%B1%E5%AF%86%E7%A0%81%E9%A3%8E%E9%99%A9"><span class="toc-number">2.2.</span> <span class="toc-text">2. 弱密码风险</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%A2%91%E7%B9%81%E9%AA%8C%E8%AF%81%E7%B9%81%E7%90%90"><span class="toc-number">2.3.</span> <span class="toc-text">3. 频繁验证繁琐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%94%B9%E9%80%A0%E6%88%90%E6%9C%AC%E9%AB%98"><span class="toc-number">2.4.</span> <span class="toc-text">4. 改造成本高</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0"><span class="toc-number">3.</span> <span class="toc-text">解决方案概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E7%89%B9%E7%82%B9"><span class="toc-number">3.1.</span> <span class="toc-text">方案特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">3.2.</span> <span class="toc-text">技术选型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.</span> <span class="toc-text">架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%9E%B6%E6%9E%84"><span class="toc-number">4.1.</span> <span class="toc-text">网络架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">4.2.</span> <span class="toc-text">组件说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">核心实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker-Compose-%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.</span> <span class="toc-text">Docker Compose 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">5.2.</span> <span class="toc-text">Nginx 配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-HTTP-%E5%92%8C%E4%BA%8B%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.1.</span> <span class="toc-text">1. HTTP 和事件配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%99%BB%E5%BD%95%E5%85%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.2.</span> <span class="toc-text">2. 登录入口实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%B8%BB%E5%85%A5%E5%8F%A3%E9%AA%8C%E8%AF%81%E9%80%BB%E8%BE%91"><span class="toc-number">5.2.3.</span> <span class="toc-text">3. 主入口验证逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">5.2.4.</span> <span class="toc-text">4. 退出登录（可选）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.</span> <span class="toc-text">部署步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%87%86%E5%A4%87%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">6.1.</span> <span class="toc-text">第一步：准备目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E7%94%9F%E6%88%90%E8%AE%A4%E8%AF%81%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.</span> <span class="toc-text">第二步：生成认证文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E7%94%9F%E6%88%90-Cookie-%E7%AD%BE%E5%90%8D%E5%AF%86%E9%92%A5"><span class="toc-number">6.3.</span> <span class="toc-text">第三步：生成 Cookie 签名密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">6.4.</span> <span class="toc-text">第四步：编写配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">6.5.</span> <span class="toc-text">第五步：启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C"><span class="toc-number">6.6.</span> <span class="toc-text">第六步：验证效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5"><span class="toc-number">7.</span> <span class="toc-text">常见错误排查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E4%B8%80%EF%BC%9Amap-%E6%8C%87%E4%BB%A4%E4%BD%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">7.1.</span> <span class="toc-text">错误一：map 指令位置错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E4%BA%8C%EF%BC%9A%E7%BC%BA%E5%B0%91-HMAC-%E6%A8%A1%E5%9D%97"><span class="toc-number">7.2.</span> <span class="toc-text">错误二：缺少 HMAC 模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E4%B8%89%EF%BC%9ACookie-%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E5%A4%B1%E8%B4%A5"><span class="toc-number">7.3.</span> <span class="toc-text">错误三：Cookie 签名验证失败</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%AE"><span class="toc-number">8.</span> <span class="toc-text">安全建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%99%90%E5%88%B6%E6%9D%A5%E6%BA%90-IP"><span class="toc-number">8.1.</span> <span class="toc-text">1. 限制来源 IP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9%E7%99%BB%E5%BD%95%E8%B7%AF%E5%BE%84"><span class="toc-number">8.2.</span> <span class="toc-text">2. 修改登录路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81"><span class="toc-number">8.3.</span> <span class="toc-text">3. 配置访问限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%90%AF%E7%94%A8-HTTPS"><span class="toc-number">8.4.</span> <span class="toc-text">4. 启用 HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%8D%A2%E5%AF%86%E9%92%A5"><span class="toc-number">8.5.</span> <span class="toc-text">5. 定期更换密钥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E8%80%83%E9%87%8F"><span class="toc-number">9.</span> <span class="toc-text">性能考量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Cookie-%E9%AA%8C%E8%AF%81%E5%BC%80%E9%94%80"><span class="toc-number">9.1.</span> <span class="toc-text">1. Cookie 验证开销</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8"><span class="toc-number">9.2.</span> <span class="toc-text">2. 内存占用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%BF%9E%E6%8E%A5%E5%A4%8D%E7%94%A8"><span class="toc-number">9.3.</span> <span class="toc-text">3. 连接复用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">10.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">11.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8E%81-MiniMax-%E8%B7%A8%E5%B9%B4%E7%A6%8F%E5%88%A9%E6%9D%A5%E8%A2%AD%EF%BC%81"><span class="toc-number">12.</span> <span class="toc-text">🎁 MiniMax 跨年福利来袭！</span></a></li></ol>
                </div>
            </button>
            

            

            <a href="#nexmoe-content" class="backtop toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
        </div>
    </div>
</div></div><div id="nexmoe-footer"><!--!--></div><div id="nexmoe-search-space"><div class="search-container"><div class="search-header"><div class="search-input-container"><input class="search-input" type="text" placeholder="Search" onInput="sinput();"></div><a class="search-close" onclick="sclose();">×</a></div><div class="search-body"></div></div></div><div><script src="https://cdn.jsdelivr.net/npm/mathjax@latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});
MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});</script>
</div></body></html>