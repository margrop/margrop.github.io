<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>搭梯子或机场：V2RAY配置WebSocket &#43; TLS &#43; Web &#43; CDN - 魔都水滴</title>
<meta name="description" content="v2ray现在最安全的配置就是WebSocket &#43; TLS &#43; Web &#43; CDN 了，访问的是443端口，直接访问是一个网站，通过客户端连接后他是个梯子(飞机)。外观上看是一个刮胡刀，原来呢，它是一个吹风机。">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://blog.margrop.net/post/fuckgfw-v2ray-websocket-tls-web-cdn/">

<meta property="og:site_name" content="魔都水滴">
<meta property="og:title" content="搭梯子或机场：V2RAY配置WebSocket &#43; TLS &#43; Web &#43; CDN - 魔都水滴">
<meta property="og:description" content="v2ray现在最安全的配置就是WebSocket &#43; TLS &#43; Web &#43; CDN 了，访问的是443端口，直接访问是一个网站，通过客户端连接后他是个梯子(飞机)。外观上看是一个刮胡刀，原来呢，它是一个吹风机。">
<meta property="og:url" content="https://blog.margrop.net/post/fuckgfw-v2ray-websocket-tls-web-cdn/">
<meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.margrop.net/images/avatar.png"><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="搭梯子或机场：V2RAY配置WebSocket &#43; TLS &#43; Web &#43; CDN - 魔都水滴">
<meta name="twitter:description" content="v2ray现在最安全的配置就是WebSocket &#43; TLS &#43; Web &#43; CDN 了，访问的是443端口，直接访问是一个网站，通过客户端连接后他是个梯子(飞机)。外观上看是一个刮胡刀，原来呢，它是一个吹风机。"><meta name="twitter:image" content="https://blog.margrop.net/images/avatar.png"><meta property="article:published_time" content="2021-01-26T13:44:36&#43;08:00">
<meta property="article:modified_time" content="2021-01-26T13:44:36&#43;08:00"><meta property="article:tag" content="梯子"><meta property="article:tag" content="fuckgfw"><meta property="article:tag" content="gfw"><meta property="article:tag" content="websocket"><meta property="article:tag" content="tls"><meta property="article:tag" content="web"><meta property="article:tag" content="cdn"><meta property="article:tag" content="v2ray"><meta property="article:tag" content="caddy2"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"魔都水滴"},"dateModified":"2021-01-26T13:44:36+08:00","datePublished":"2021-01-26T13:44:36+08:00","description":"v2ray现在最安全的配置就是WebSocket + TLS + Web + CDN 了，访问的是443端口，直接访问是一个网站，通过客户端连接后他是个梯子(飞机)。外观上看是一个刮胡刀，原来呢，它是一个吹风机。","headline":"搭梯子或机场：V2RAY配置WebSocket + TLS + Web + CDN","mainEntityOfPage":"https://blog.margrop.net/post/fuckgfw-v2ray-websocket-tls-web-cdn/","url":"https://blog.margrop.net/post/fuckgfw-v2ray-websocket-tls-web-cdn/"}</script>
    <meta name="baidu-site-verification" content="code-sVFZ8SER59" />
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J2W592DHJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3J2W592DHJ');
    </script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.8; }
        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
        .content { line-height: 1.8; }
        .content code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        .content pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }
        .content img { max-width: 100%; height: auto; }
        .tags { margin-top: 30px; }
        .tag { background: #eee; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
        nav { margin-bottom: 30px; }
        nav a { margin-right: 15px; text-decoration: none; color: #333; }
        nav a:hover { color: #006CFF; }
        a { color: #006CFF; }
    </style>
</head>
<body>
    <nav>
        <a href="/">首页</a>
        <a href="/post/">归档</a>
        <a href="/tag/">标签</a>
    </nav>
    <article>
        <h1>搭梯子或机场：V2RAY配置WebSocket &#43; TLS &#43; Web &#43; CDN</h1>
        <div class="meta">
            发布时间: 2021-01-26
            
            | 标签: 
            
                
                <a href="/tag/%E6%A2%AF%E5%AD%90"><span class="tag">梯子</span></a>
            
                
                <a href="/tag/fuckgfw"><span class="tag">fuckgfw</span></a>
            
                
                <a href="/tag/gfw"><span class="tag">gfw</span></a>
            
                
                <a href="/tag/websocket"><span class="tag">websocket</span></a>
            
                
                <a href="/tag/tls"><span class="tag">tls</span></a>
            
                
                <a href="/tag/web"><span class="tag">web</span></a>
            
                
                <a href="/tag/cdn"><span class="tag">cdn</span></a>
            
                
                <a href="/tag/v2ray"><span class="tag">v2ray</span></a>
            
                
                <a href="/tag/caddy2"><span class="tag">caddy2</span></a>
            
            
        </div>
        <div class="content">
            <p><code>v2ray</code>现在最安全的配置就是<code>WebSocket + TLS + Web + CDN</code> 了，访问的是<code>443</code>端口，直接访问是一个网站，通过客户端连接后他是个梯子(飞机)。外观上看是一个刮胡刀，原来呢，它是一个吹风机。</p>
<h1 id="1检查系统的时间和时区是否正确否则无法正常连接">1、检查系统的时间和时区是否正确，否则无法正常连接</h1>
<ul>
<li>本站博主曾因为服务器时间和时区的问题，导致无法正常连接<code>V2Ray</code>，折腾了一整天。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>date
</span></span><span style="display:flex;"><span>cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></span><span style="display:flex;"><span>date
</span></span></code></pre></div><h1 id="2自备海外vps服务器">2、自备海外VPS服务器</h1>
<ul>
<li>自行购买一台海外VPS服务器，需要<code>KVM</code>的VPS，不要买成了<code>OpenVZ</code>，便宜没好货</li>
<li>VPS服务器需要自带<code>独立IP</code></li>
</ul>
<blockquote>
<p>推荐：<a href="https://www.vpeasy.com/">VPEasy</a>，老牌服务商，最低套餐1024M/1CPU/25G SSD/1T流量 ，KVM架构，每年28刀，首年使用<code>FirstYear</code>优惠码，可以75折。博主6年前开始购买，已经使用6年了。
<img src="/post-images/vpeasy-transactions-1.jpg" alt=""></p>
</blockquote>
<ul>
<li>海外VPS服务器一般需要海外<code>Paypal</code>账号，<code>Visa</code>或者<code>MasterCard</code>的信用卡进行支付美元。</li>
</ul>
<h1 id="3自备cloudflare账号和域名">3、自备CloudFlare账号和域名</h1>
<ul>
<li>自行注册一个顶级域名，并将域名解析到`CloudFlare</li>
</ul>
<h2 id="31国内目前最便宜的域名">3.1、国内目前最便宜的域名</h2>
<ul>
<li><code>DNSPod</code>国内<code>.xyz</code>域名注册，最低注册6元2年</li>
</ul>
<blockquote>
<p>访问<a href="https://cloud.tencent.com/act/pro/DNSPodDomainsCarnival">https://cloud.tencent.com/act/pro/DNSPodDomainsCarnival</a>，领取2张5元代金券
然后注册10位数字以下的<code>.xyz</code>域名，新注册8元，续费8元
注册时，可以使用5元代金券，减后只需要3元
然后立即续费1年，又可以使用5元代金券，减后又只需要3元
记得国内注册域名，都需要<code>实名认证</code></p>
</blockquote>
<h2 id="32海外注册域名">3.2、海外注册域名</h2>
<blockquote>
<p>推荐：<a href="https://namesilo.com">https://namesilo.com</a>，推荐<code>top域名</code>，每年4.89刀
下面为<code>namesile.com</code>的修改域名解析服务器的方法，仅供参考
<img src="/post-images/namesile-dns-1.jpg" alt="">
<img src="/post-images/namesile-dns-2.jpg" alt=""></p>
</blockquote>
<ul>
<li>自行注册一个<code>CloudFlare</code>账号，并添加自己的域名</li>
</ul>
<blockquote>
<p>入口：<a href="https://www.cloudflare.com">https://www.cloudflare.com</a>
<img src="/post-images/cloudflare-addsite-1.jpg" alt="">
<img src="/post-images/cloudflare-addsite-2.jpg" alt="">
<img src="/post-images/cloudflare-addsite-3.jpg" alt="">
<img src="/post-images/cloudflare-addsite-4.jpg" alt=""></p>
</blockquote>
<ul>
<li>在<code>CloudFlare</code>里面的域名管理<code>DNS设置</code>中，新增<code>二级域名</code>，<code>A记录</code>指向<code>VPS</code>的<code>IP地址</code>，<code>Proxy Status</code>为默认值<code>Proxied</code>
<img src="/post-images/cloudflare-dns-add-1.jpg" alt=""></li>
<li>二级域名增加后，需要取域名管理界面的<code>SSL/TLS设置</code>，把<code>SSL/TLS</code>的加密模式改为<code>Full（strict）</code>，如果已经是的，就不用改。
<img src="/post-images/cloudflare-ssl-mode-1.jpg" alt=""></li>
</ul>
<h1 id="4安装caddy2">4、安装Caddy2</h1>
<p>提供web服务的还有<code>Nginx</code> 和<code>Apache</code>，为什么选用<code>Caddy2</code>？
因为他简单，可以自动申请<code>SSL</code>证书。
原文中的<code>Caddy</code>已经无法正常从官网安装，这里是安装<code>Caddy2</code>的方法</p>
<blockquote>
<p>可选从官网下载，或者从本站下载</p>
</blockquote>
<h2 id="从官网下载caddy2">从官网下载<code>Caddy2</code></h2>
<ul>
<li>需要包含<code>CloudFlare</code>插件</li>
<li>目前为最新版本<code>v2.3.0 h1:fnrqJLa3G5vfxcxmOH/+kJOcunPLhSBnjgIvjXV/QTA=</code></li>
<li>进入<a href="https://caddyserver.com/download">官网下载</a></li>
<li>选择<code>Platform</code>（大部分都是选<code>Linux amd64</code>），勾选CloudFlare插件，再点击<code>Download</code>
<img src="/post-images/caddyserver-download-1.jpg" alt=""></li>
<li>把下载到本地的<code>Caddy2</code>文件上传到VPS下面的<code>~/tools/caddy</code>目录即可。</li>
</ul>
<h2 id="从本站下载caddy2">从本站下载<code>Caddy2</code></h2>
<ul>
<li>已含<code>CloudFlare</code>插件</li>
<li>目前为旧版本<code>v2.2.1 h1:Q62GWHMtztnvyRU+KPOpw6fNfeCD3SkwH7SfT1Tgt2c=</code></li>
<li>进入VPS下面的<code>~/tools/caddy</code>目录，运行<code>wget</code>命令即可</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p ~/tools/caddy
</span></span><span style="display:flex;"><span>cd ~/tools/caddy
</span></span><span style="display:flex;"><span>wget -O caddy2 https://download.margrop.net/d/oneindex/CENTOS/caddy2_2.2.1
</span></span></code></pre></div><ul>
<li>查看<code>Caddy2</code>版本</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chmod +x caddy2
</span></span><span style="display:flex;"><span>caddy2 -version
</span></span></code></pre></div><h1 id="5安装v2ray">5、安装v2ray</h1>
<ul>
<li><code>v2ray</code>一键安装命令</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bash &lt;<span style="color:#f92672">(</span>curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh<span style="color:#f92672">)</span>
</span></span></code></pre></div><ul>
<li><code>v2ray</code>正常安装时的安装日志</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>installed: /usr/local/bin/v2ray
</span></span><span style="display:flex;"><span>installed: /usr/local/bin/v2ctl
</span></span><span style="display:flex;"><span>installed: /usr/local/share/v2ray/geoip.dat
</span></span><span style="display:flex;"><span>installed: /usr/local/share/v2ray/geosite.dat
</span></span><span style="display:flex;"><span>installed: /usr/local/etc/v2ray/config.json
</span></span><span style="display:flex;"><span>installed: /var/log/v2ray/
</span></span><span style="display:flex;"><span>installed: /var/log/v2ray/access.log
</span></span><span style="display:flex;"><span>installed: /var/log/v2ray/error.log
</span></span><span style="display:flex;"><span>installed: /etc/systemd/system/v2ray.service
</span></span><span style="display:flex;"><span>installed: /etc/systemd/system/v2ray@.service
</span></span><span style="display:flex;"><span>removed: /tmp/tmp.iO3bDdOqa9
</span></span><span style="display:flex;"><span>info: V2Ray v4.33.0 is installed.
</span></span><span style="display:flex;"><span>You may need to execute a command to remove dependent software: yum remove curl unzip
</span></span><span style="display:flex;"><span>Please execute the command: systemctl enable v2ray; systemctl start v2ray
</span></span></code></pre></div><h1 id="6配置并启动v2ray">6、配置并启动v2ray</h1>
<ul>
<li>编辑<code>v2ray</code>配置文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /usr/local/etc/v2ray/config.json
</span></span></code></pre></div><ul>
<li>JSON文件里面的<code>UUID</code>相当于密码，请务必自行生成并妥善保管</li>
</ul>
<blockquote>
<p>Mac/Unix/Linux系统：控制台输入<code>uuidgen</code>，即可生成<code>UUID</code>
Windows系统：PowerShell控制台输入<code>[guid]::NewGuid()</code>，即可生成<code>UUID</code></p>
</blockquote>
<ul>
<li>JSON文件里面的<code>{RANDOM_PATH}</code>为WebSocket的访问URL，以目前的使用经验，最好使用随机字符串。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;inbound&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">10000</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;listen&#34;</span>:<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;vmess&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;clients&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;E5B33B5A-A241-4246-B8D9-A260FBBAFCCF&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;alterId&#34;</span>: <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;streamSettings&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;network&#34;</span>: <span style="color:#e6db74">&#34;ws&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;wsSettings&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/{RANDOM_PATH}&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;outbound&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;freedom&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;settings&#34;</span>: {}
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>启动V2Ray</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl start v2ray
</span></span></code></pre></div><ul>
<li>设置V2Ray开机自启动</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable v2ray
</span></span></code></pre></div><h1 id="7配置caddyfile2">7、配置Caddyfile2</h1>
<p>在 <code>/etc/caddy </code> 目录创建 <code>Caddyfile2</code> 文件，没有目录就创建目录，编辑<code>Caddyfile2</code>文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir /etc/caddy
</span></span><span style="display:flex;"><span>cd /etc/caddy
</span></span><span style="display:flex;"><span>vim /etc/caddy/Caddyfile2
</span></span></code></pre></div><ul>
<li>下面为<code>blog.margrop.net</code>域名为本站域名，请自行修改，建议使用刚才配置的二级域名。</li>
<li><code>{RANDOM_PATH}</code>，必须和上面配置一样的。</li>
<li>dns cloudflare 这里的配置为CloudFlare的API_KEY，请自行修改，这是<a href="https://caddyserver.com/docs/modules/dns.providers.cloudflare">插件文档</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">blog.margrop.net</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">root</span> <span style="color:#960050;background-color:#1e0010">*</span> <span style="color:#960050;background-color:#1e0010">/usr/share/caddy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">file_server</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">log</span> <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">output</span> <span style="color:#960050;background-color:#1e0010">file</span> <span style="color:#960050;background-color:#1e0010">/var/log/caddy/vps.log</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">tls</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">dns</span> <span style="color:#960050;background-color:#1e0010">cloudflare</span> <span style="color:#960050;background-color:#1e0010">g9_uKv1RrXXXXXXHOPfXXXXXXYNZGXXXXXXJh3qp</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">@v</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ray_websocket</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">path</span> <span style="color:#960050;background-color:#1e0010">/{RANDOM_PATH</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">header</span> <span style="color:#960050;background-color:#1e0010">Connection</span> <span style="color:#960050;background-color:#1e0010">*Upgrade*</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">header</span> <span style="color:#960050;background-color:#1e0010">Upgrade</span> <span style="color:#960050;background-color:#1e0010">websocket</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">reverse_proxy</span> <span style="color:#960050;background-color:#1e0010">@v</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">ray_websocket</span> <span style="color:#960050;background-color:#1e0010">localhost:</span><span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div><h1 id="8配置caddy-json">8、配置Caddy JSON</h1>
<ul>
<li><code>Caddy2</code>的主要配置文件是<code>Caddy JSON</code>，但这个配置文件太难写了。</li>
<li>所以我们这里把上一步编辑好的<code>Caddyfile2</code>文件转换成<code>Caddy JSON</code>文件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ~/tools/caddy
</span></span><span style="display:flex;"><span>./caddy2 adapt --config /etc/caddy/Caddyfile2 &gt; ~/tools/caddy/config.json
</span></span><span style="display:flex;"><span>cat ~/tools/caddy/config.json
</span></span></code></pre></div><h1 id="9启动并上传caddy-json">9、启动并上传Caddy JSON</h1>
<ul>
<li>启动<code>Caddy2</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ~/tools/caddy
</span></span><span style="display:flex;"><span>./caddy2 start
</span></span></code></pre></div><ul>
<li>上传<code>Caddy JSON</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl localhost:2019/config/
</span></span><span style="display:flex;"><span>curl localhost:2019/load -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d @config.json
</span></span><span style="display:flex;"><span>curl localhost:2019/config/
</span></span></code></pre></div><h1 id="10v2ray客户端配置">10、v2ray客户端配置</h1>
<ul>
<li><code>v2ray</code>客户端建议和服务端的版本保持一致</li>
<li>这里客户端同时启用的<code>socks5</code>代理和<code>http</code>代理，均无验证，<code>socks5</code>代理使用<code>1080</code>端口，<code>http</code>代理使用<code>1081</code>端口， 且都支持局域网内连接，方便同一局域网下的其他设备搭乘顺风机。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;inbounds&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">1080</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;listen&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;socks&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;domainOverride&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;tls&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;auth&#34;</span>: <span style="color:#e6db74">&#34;noauth&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;udp&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">1081</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;listen&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;http&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;domainOverride&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;tls&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;http&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;auth&#34;</span>: <span style="color:#e6db74">&#34;noauth&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;udp&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;outbound&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;vmess&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;vnext&#34;</span>: [
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;address&#34;</span>: <span style="color:#e6db74">&#34;blog.margrop.net&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#ae81ff">443</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&#34;users&#34;</span>: [
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;E5B33B5A-A241-4246-B8D9-A260FBBAFCCF&#34;</span>,
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">&#34;alterId&#34;</span>: <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;streamSettings&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;network&#34;</span>: <span style="color:#e6db74">&#34;ws&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;security&#34;</span>: <span style="color:#e6db74">&#34;tls&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;wsSettings&#34;</span>: {
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/{RANDOM_PATH}&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>UUID</code>，<code>域名</code>和<code>{RANDOM_PATH}</code>，必须和服务端配置一样的。</p>
<h1 id="11试运行">11、试运行</h1>
<pre tabindex="0"><code>看看有没有报错，没有报错就访问下网站看是否正常，如果正常就证明caddy2配置无误。
</code></pre><blockquote>
<p>以上全部操作在CentOS 7上亲自验证，可行。
目前这个文档还属于简版操作手册，后续再慢慢补充每一步详细的操作流程。</p>
</blockquote>
<h1 id="12caddy2配置自动启动">12、Caddy2配置自动启动</h1>
<p>创建或编辑 caddy2.service 文件
使用以下命令编辑服务文件：</p>
<pre tabindex="0"><code>sudo nano /etc/systemd/system/caddy2.service
</code></pre><p>将服务文件内容更新为以下内容</p>
<pre tabindex="0"><code>[Unit]
Description=Start Caddy with Config on Boot
After=network.target

[Service]
User=root
WorkingDirectory=/root/tools/caddy
ExecStart=/root/tools/caddy/caddy2 run --config /root/tools/caddy/config.json
wqRestart=on-failure
Environment=HOME=/root

[Install]
WantedBy=multi-user.target
</code></pre><p>重新加载 systemd 配置并启动服务
保存并关闭文件后，执行以下命令：</p>
<pre tabindex="0"><code>sudo systemctl daemon-reload
sudo systemctl restart caddy2.service
sudo systemctl enable caddy2.service
</code></pre><p>验证服务状态
检查服务是否正常运行：</p>
<pre tabindex="0"><code>sudo systemctl status caddy2.service
</code></pre><h1 id="13存档caddy1使用方法">13、存档，Caddy1使用方法</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#测试运行</span>
</span></span><span style="display:flex;"><span>caddy -agree -conf /etc/caddy/Caddyfile
</span></span><span style="display:flex;"><span><span style="color:#75715e">#正式运行</span>
</span></span><span style="display:flex;"><span>nohup caddy -agree -conf /etc/caddy/Caddyfile &gt; /root/caddy.log 2&gt;&amp;<span style="color:#ae81ff">1</span> &amp;
</span></span></code></pre></div><h1 id="参考">参考</h1>
<p><a href="https://www.lingbaoboy.com/2019/03/v2raywebsocket-tls-web.html">搭梯子：V2RAY配置WebSocket + TLS + Web</a>
<a href="https://toutyrater.github.io/advanced/wss_and_web.html">WebSocket+TLS+Web</a>
<a href="https://caddyserver.com/docs/modules/dns.providers.cloudflare">Module dns.providers.cloudflare</a>
<a href="https://caddyserver.com/docs/quick-starts/caddyfile">Caddyfile Quick-start</a>
<a href="https://caddyserver.com/docs/install">Install</a></p>
        </div>
    </article>
    
    
  
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container" style="margin-top:40px"></div>
<script>
  (function(){
    var gitalk = new Gitalk({
      clientID: '3181fd94e501cc5db0ad',
      clientSecret: 'af1dab79dae02c69296e6615bfcecf47fc8615ee',
      repo: 'margropcomment.margrop.io',
      owner: 'margrop',
      admin: "[\"margrop\"]",
      id: '660877dc67bb5223f1fd3ca8c1bdb809ebcaecff',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  })();
</script>
  



    <script type="text/javascript" src="https://js.users.51.la/21044367.js"></script>
</body>
</html>
