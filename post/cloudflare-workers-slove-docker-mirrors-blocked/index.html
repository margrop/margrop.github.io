<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>cloudflare workers 解决docker无法拉取镜像问题 - 魔都水滴</title>
<meta name="description" content="由于某些原因，目前国内无法正常拉取docker镜像，去年写的加速拉取镜像的办法也没法用，困难总比办法多（不是），干脆新写一篇教程，利用cloudflare workers 解决docker无法拉取镜像问题。 本篇利用cloudflare workers来解决无法拉取镜像问题，关于cloudflare这里不再过多介 …">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://blog.margrop.net/post/cloudflare-workers-slove-docker-mirrors-blocked/">

<meta property="og:site_name" content="魔都水滴">
<meta property="og:title" content="cloudflare workers 解决docker无法拉取镜像问题 - 魔都水滴">
<meta property="og:description" content="由于某些原因，目前国内无法正常拉取docker镜像，去年写的加速拉取镜像的办法也没法用，困难总比办法多（不是），干脆新写一篇教程，利用cloudflare workers 解决docker无法拉取镜像问题。 本篇利用cloudflare workers来解决无法拉取镜像问题，关于cloudflare这里不再过多介 …">
<meta property="og:url" content="https://blog.margrop.net/post/cloudflare-workers-slove-docker-mirrors-blocked/">
<meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.margrop.net/images/avatar.png"><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="cloudflare workers 解决docker无法拉取镜像问题 - 魔都水滴">
<meta name="twitter:description" content="由于某些原因，目前国内无法正常拉取docker镜像，去年写的加速拉取镜像的办法也没法用，困难总比办法多（不是），干脆新写一篇教程，利用cloudflare workers 解决docker无法拉取镜像问题。 本篇利用cloudflare workers来解决无法拉取镜像问题，关于cloudflare这里不再过多介 …"><meta name="twitter:image" content="https://blog.margrop.net/images/avatar.png"><meta property="article:published_time" content="2024-06-10T14:16:26&#43;08:00">
<meta property="article:modified_time" content="2024-06-10T14:16:26&#43;08:00"><meta property="article:tag" content="docker"><meta property="article:tag" content="cloudflare"><meta property="article:tag" content="fuckgfw"><meta property="article:tag" content="worker"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"魔都水滴"},"dateModified":"2024-06-10T14:16:26+08:00","datePublished":"2024-06-10T14:16:26+08:00","description":"由于某些原因，目前国内无法正常拉取docker镜像，去年写的加速拉取镜像的办法也没法用，困难总比办法多（不是），干脆新写一篇教程，利用cloudflare workers 解决docker无法拉取镜像问题。 本篇利用cloudflare workers来解决无法拉取镜像问题，关于cloudflare这里不再过多介 …","headline":"cloudflare workers 解决docker无法拉取镜像问题","mainEntityOfPage":"https://blog.margrop.net/post/cloudflare-workers-slove-docker-mirrors-blocked/","url":"https://blog.margrop.net/post/cloudflare-workers-slove-docker-mirrors-blocked/"}</script>
    <meta name="baidu-site-verification" content="code-sVFZ8SER59" />
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J2W592DHJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3J2W592DHJ');
    </script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.8; }
        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
        .content { line-height: 1.8; }
        .content code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        .content pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }
        .content img { max-width: 100%; height: auto; }
        .tags { margin-top: 30px; }
        .tag { background: #eee; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
        nav { margin-bottom: 30px; }
        nav a { margin-right: 15px; text-decoration: none; color: #333; }
        nav a:hover { color: #006CFF; }
        a { color: #006CFF; }
    </style>
</head>
<body>
    <nav>
        <a href="/">首页</a>
        <a href="/post/">归档</a>
        <a href="/tag/">标签</a>
    </nav>
    <article>
        <h1>cloudflare workers 解决docker无法拉取镜像问题</h1>
        <div class="meta">
            发布时间: 2024-06-10
            
            | 标签: 
            
                
                <a href="/tag/docker"><span class="tag">docker</span></a>
            
                
                <a href="/tag/cloudflare"><span class="tag">cloudflare</span></a>
            
                
                <a href="/tag/fuckgfw"><span class="tag">fuckgfw</span></a>
            
                
                <a href="/tag/worker"><span class="tag">worker</span></a>
            
            
        </div>
        <div class="content">
            <p>由于某些原因，目前国内无法正常拉取docker镜像，去年写的加速拉取镜像的办法也没法用，困难总比办法多（不是），干脆新写一篇教程，利用cloudflare workers 解决docker无法拉取镜像问题。</p>
<p>本篇利用cloudflare workers来解决无法拉取镜像问题，关于cloudflare这里不再过多介绍，cloudflare workers服务也是免费，不懂的童鞋可以自行翻看往期文章《<a href="http://mp.weixin.qq.com/s?__biz=MzIxMjE1NDQxNA==&amp;mid=2247484002&amp;idx=1&amp;sn=5cf3b8876df7d871774641c5f24261d7&amp;chksm=974b2323a03caa35e053659efda5e285635f83d011cadf54e7c05288f40a4df1811fcf0338ff&amp;scene=21#wechat_redirect">cloudflare加快github下载</a>》。<strong>如果看完本篇也不想动手，也可以在后台回复“jsdc”获取我搭建好的公共服务地址</strong>。</p>
<p><strong>前排准备：</strong></p>
<p>1.一个域名，不想花钱购买域名可以用免费的二级域名，我之前也有写过相关文章《<a href="http://mp.weixin.qq.com/s?__biz=MzIxMjE1NDQxNA==&amp;mid=2247483945&amp;idx=1&amp;sn=abe651003c71d37c25b29cd6ea54a775&amp;chksm=974b2368a03caa7e8ccdab8d0d104076540990a643731bd60bb9c3bbb04dc81c83dba4eedad9&amp;scene=21#wechat_redirect">免费申请注册eu.org二级域名</a>》。</p>
<p>2.cloudflare（以下简称cf）账号。</p>
<p><strong>一、添加域名ns服务器</strong></p>
<p>cf入门以及添加ns解析相关内容请看《<a href="http://mp.weixin.qq.com/s?__biz=MzIxMjE1NDQxNA==&amp;mid=2247484203&amp;idx=1&amp;sn=a3df13929194c1e0eb9af4383c4808f9&amp;chksm=974b226aa03cab7c137d6775325cfe64f82d405497c5614d01169f5fb5c4b71227c7ed870f07&amp;scene=21#wechat_redirect">利用cloudflare让ipv4与ipv6互通</a>》，这里不再赘述。</p>
<p><strong>二、部署服务</strong></p>
<p>登录cf后，进入Workers 和 Pages，再点击概述，创建应用程序。</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5yRpK3GKN07INchxwdWnI7HvopbRCkrIn7aQNMgxs8aHlTeLBYDRmzVQ/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p>之后再点击创建worker，输入项目名称，然后在下面会有一行小字：您的 Worker 将被部署到：xxxxx，这个是cf自动分配给你的域名，通过这个就可以访问这个项目，有童鞋就会想那为啥还要自己准备域名，因为很简单，cf分配的那个域名目前打不开，只能绑定自己的域名。输入完名称后点击保存，会出现默认的worker.js，这个不用管，点击完成就行</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5y0lHWbwNGgZhWQDMsaia4SrSGCxgG7zN5TdXY4AaUjicwa2AUWMJyz9hA/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5y1Nh0Je04ESwa8NEuyLico5Q6rCE0qqEFUV4N1aXbajwal2XE3LgXvUA/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5ykOUEgpYqJLaiaaCHuJ6921r2EaokTIeFMOHSOoOllCVqQibmN7KA9haw/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p>完成后会出现初始界面，点击编辑代码。先删掉默认的代码。</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5yIBoibERdTQhSL80zuGUXp7iahr6mWpd11qqe5zjndokdjIF603IibJf9w/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5ykbGkz2BzjDCBmA4aQ2icV7UicVkQyY9LshdN2dz3cxCoFxpATiaoM6PAQ/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p>然后把以下代码复制到里面，并替换workers_url为自己的域名，再点击部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#e6db74">&#39;use strict&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">hub_host</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;registry-1.docker.io&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">auth_url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://auth.docker.io&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">workers_url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://自己的域名&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PREFLIGHT_INIT</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">204</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Headers</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;access-control-allow-origin&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;*&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;access-control-allow-methods&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;access-control-max-age&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;1728000&#39;</span>,
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">makeRes</span>(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> {}) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">headers</span>[<span style="color:#e6db74">&#39;access-control-allow-origin&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#a6e22e">body</span>, {<span style="color:#a6e22e">status</span>, <span style="color:#a6e22e">headers</span>})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">newUrl</span>(<span style="color:#a6e22e">urlStr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#a6e22e">urlStr</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#39;fetch&#39;</span>, <span style="color:#a6e22e">e</span> =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ret</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fetchHandler</span>(<span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; <span style="color:#a6e22e">makeRes</span>(<span style="color:#e6db74">&#39;cfworker error:\n&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">stack</span>, <span style="color:#ae81ff">502</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">respondWith</span>(<span style="color:#a6e22e">ret</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fetchHandler</span>(<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getReqHeader</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">key</span>) =&gt; <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">headers</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">key</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">URL</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">url</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">pathname</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;/token&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">token_parameter</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Host&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;auth.docker.io&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;User-Agent&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;User-Agent&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Accept&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;Accept&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Accept-Language&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;Accept-Language&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Accept-Encoding&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;Accept-Encoding&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Connection&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;keep-alive&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;Cache-Control&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;max-age=0&#39;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">token_url</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">auth_url</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">pathname</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">search</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Request</span>(<span style="color:#a6e22e">token_url</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">request</span>), <span style="color:#a6e22e">token_parameter</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">url</span>.<span style="color:#a6e22e">hostname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">hub_host</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">parameter</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Host&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">hub_host</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;User-Agent&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;User-Agent&#34;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Accept&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;Accept&#34;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Accept-Language&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;Accept-Language&#34;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Accept-Encoding&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;Accept-Encoding&#34;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Connection&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;keep-alive&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;Cache-Control&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;max-age=0&#39;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cacheTtl</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3600</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">headers</span>.<span style="color:#a6e22e">has</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">parameter</span>.<span style="color:#a6e22e">headers</span>.<span style="color:#a6e22e">Authorization</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getReqHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">original_response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Request</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">request</span>), <span style="color:#a6e22e">parameter</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">original_response_clone</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">original_response</span>.<span style="color:#a6e22e">clone</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">original_text</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">original_response_clone</span>.<span style="color:#a6e22e">body</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">response_headers</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">original_response</span>.<span style="color:#a6e22e">headers</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">new_response_headers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Headers</span>(<span style="color:#a6e22e">response_headers</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">original_response</span>.<span style="color:#a6e22e">status</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">new_response_headers</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;Www-Authenticate&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">auth</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">new_response_headers</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;Www-Authenticate&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">re</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RegExp(<span style="color:#a6e22e">auth_url</span>, <span style="color:#e6db74">&#39;g&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">new_response_headers</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#34;Www-Authenticate&#34;</span>, <span style="color:#a6e22e">response_headers</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;Www-Authenticate&#34;</span>).<span style="color:#a6e22e">replace</span>(<span style="color:#a6e22e">re</span>, <span style="color:#a6e22e">workers_url</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">new_response_headers</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;Location&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">httpHandler</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">new_response_headers</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;Location&#34;</span>))
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#a6e22e">original_text</span>, {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">status</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">new_response_headers</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">httpHandler</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">pathname</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reqHdrRaw</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">headers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// preflight
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">method</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;OPTIONS&#39;</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reqHdrRaw</span>.<span style="color:#a6e22e">has</span>(<span style="color:#e6db74">&#39;access-control-request-headers&#39;</span>)
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#66d9ef">null</span>, <span style="color:#a6e22e">PREFLIGHT_INIT</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">rawLen</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reqHdrNew</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Headers</span>(<span style="color:#a6e22e">reqHdrRaw</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">refer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">reqHdrNew</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;referer&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">urlStr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathname</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">urlObj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newUrl</span>(<span style="color:#a6e22e">urlStr</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @type {RequestInit} */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reqInit</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">method</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">reqHdrNew</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">redirect</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;follow&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proxy</span>(<span style="color:#a6e22e">urlObj</span>, <span style="color:#a6e22e">reqInit</span>, <span style="color:#a6e22e">rawLen</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">proxy</span>(<span style="color:#a6e22e">urlObj</span>, <span style="color:#a6e22e">reqInit</span>, <span style="color:#a6e22e">rawLen</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">urlObj</span>.<span style="color:#a6e22e">href</span>, <span style="color:#a6e22e">reqInit</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resHdrOld</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">headers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resHdrNew</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Headers</span>(<span style="color:#a6e22e">resHdrOld</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// verify
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rawLen</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newLen</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">resHdrOld</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;content-length&#39;</span>) <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">badLen</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">rawLen</span> <span style="color:#f92672">!==</span> <span style="color:#a6e22e">newLen</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">badLen</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">makeRes</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">body</span>, <span style="color:#ae81ff">400</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;--error&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`bad len: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">newLen</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, except: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">rawLen</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;access-control-expose-headers&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;--error&#39;</span>,
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;access-control-expose-headers&#39;</span>, <span style="color:#e6db74">&#39;*&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;access-control-allow-origin&#39;</span>, <span style="color:#e6db74">&#39;*&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;Cache-Control&#39;</span>, <span style="color:#e6db74">&#39;max-age=1500&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#e6db74">&#39;content-security-policy&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#e6db74">&#39;content-security-policy-report-only&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resHdrNew</span>.<span style="color:#66d9ef">delete</span>(<span style="color:#e6db74">&#39;clear-site-data&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Response</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">body</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">status</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">resHdrNew</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5yWU8PKMw4yHz92Ya5ib6dvECBJyiaDzzJX7I32SBBO0nbemU4V8cO0hFQ/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p>这个代码里面不包含web界面，所以直接访问会提示404，这个是正常的，不带web界面是因为添加web界面要改动几个地方，而且web界面也没用，不如从简，能保证正常拉取镜像就行。</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5yrAFxzbTNSibOtTicmB7OMVWNkjHwNACqtxcRHUWCEKxrntleQxicSftjA/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><strong>三、绑定域名并配置路由</strong></p>
<p>cf workers默认使用的是自动分配的域名，目前是不可访问，所以还需要绑定自己的域名。</p>
<p>进入项目详细-设置里面，选择触发器，点击添加路由。路由就填写对应的子（主）域名，例如主域名是“bbb.com”，想要通过“aaa.bbb.com”拉取docker，那路由就填写“aaa.bbb.com/*”，当然这里想直接用主域名也可以，没限制；区域就选择对应的主域名，然后添加路由。</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5yhpaj4dbagerS148TFfw2ohiafFW1Za7UhclcOgDibIyYeIFqwFZ9JcJg/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5y1cUMKfEr0C6nhWCyRYX9tgQUPJOF1K7eBLELtx9sfVW2QpQQfc7F9g/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5yKp3mib71HmMSeoStHTibtyamUxV6oxHOTycibeuHFNYXksAP41wL0Glvg/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p>之后进入dns解析，添加一个对应子（主）域名的解析，例如上面是用“aaa.bbb.com”，那这里就添加一个对应的ipv4解析记录；解析地址随便填写，填8.8.8.8就可以，然后旁边的小云朵一定要启用。</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5y6FPsItNXu4tf7dicCbGZApYR0uGl5t9ZGM97UVVXXVpRBwYtQXfFWkg/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><strong>四、验证并拉取镜像</strong></p>
<p>如果以上步骤都无误，就可以直接拉取docker镜像，但是需要对相应的拉取命令做更改。</p>
<p><strong>1.常规拉取镜像</strong></p>
<p>例如原拉取命令如下：</p>
<pre tabindex="0"><code>docker pull library/alpine:latest
</code></pre><p>那就需要在前面加上自己的域名：</p>
<pre tabindex="0"><code>docker pull 自己的域名/library/alpine:latest
</code></pre><p>当然也可以直接设置docker registry，替换成自己的域名即可：</p>
<pre tabindex="0"><code>sudo tee /etc/docker/daemon.json &lt;&lt;EOF
{
    &#34;registry-mirrors&#34;: [&#34;https://自己的域名&#34;]
}
EOF
</code></pre><p><strong>2.nas拉取镜像</strong></p>
<p>如果是用的nas，以威联通为例，可以直接在添加docker时候选择高级模式，输入自己的域名来拉取docker；也可以在存储库中添加对应的registry，注意供应商要选择其他，url要填写完整（带https），之后在创建容器的时候选择对应的存储库就行。</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5y6NvZY23KHxuy0TEufOtzffYmhTTjiaDuYNaUupBWAyom8hCzCe2lrcw/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5y9Qs1ZtLASJOUAJgc5LbEDLKAlib7Gv5VOntHXticRUcv4xiaCc7tOvs8A/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5yByTpdm06Sps36bNqVlU79D6HFe1UEYlxyta3oiaG8FdaOoeVEpB5Qcg/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><strong>3.其他</strong></p>
<p>其他系统或者设备参照上面的方法修改对应的源（registry）就行。</p>
<p>如果配置无误，就可以正常下载镜像了。</p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/qOpcJV8aDrdMU9PJBCzT96GWasgKtL5ypicuhyfmhiavGb1ibert4SaC2bn3UyQWyf0QqKzCzmkzxzycwY5E31xeQ/640?wx_fmt=jpeg&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p><strong>六、其他</strong></p>
<p>1.cf workers每日总计免费10w次请求额度，普通人是几乎不可能用完，但为防止滥用仍建议添加路由和规则限制他人使用。</p>
<p>2.这个本质上是利用cf来进行流量中转，受限于cf的速度，如果自己所在地区cf不可用或者速度偏低，那可以自己用服务器搭建对应的中转服务，相关内容以后再出一期。</p>
<p>3.在后台回复“jsdc”即可获取我已经搭建好的服务，但本人不保证可用性，如果被滥用会直接关闭。</p>
        </div>
    </article>
    
    
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container" style="margin-top:40px"></div>
<script>
  (function(){
    var gitalk = new Gitalk({
      clientID: '3181fd94e501cc5db0ad',
      clientSecret: 'af1dab79dae02c69296e6615bfcecf47fc8615ee',
      repo: 'margropcomment.margrop.io',
      owner: 'margrop',
      admin: ["margrop"],
      
      id: '\/post\/cloudflare-workers-slove-docker-mirrors-blo',
      
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  })();
</script>
  



    <script type="text/javascript" src="https://js.users.51.la/21044367.js"></script>
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({id: "1vVTUWl7zoRjnKXi",ck: "1vVTUWl7zoRjnKXi"})</script>
    <script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script>
    <script>
      new LingQue.Monitor().init({id:"202teQt8THXwqyve"});
    </script>
</body>
</html>
