<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PVE 磁盘巡检接入 Uptime Kuma——踩坑 404 的来龙去脉与最终脚本 - 魔都水滴</title>
<meta name="description" content="写在前面 前一篇文章教大家把 PVE 宿主机的 LVM‑Thin 用量推到 Uptime Kuma。 有同学照做后 curl 推送却报 404。本文完整复盘原因、修正脚本，并给出 可选升级方案。零基础跟着做，保证一次成功。 1 现象：curl … 404 curl -fsS --retry 3 \ …">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://blog.margrop.net/post/pve-host-virtual-machine-disk-space-monitor-experience-step-two/">

<meta property="og:site_name" content="魔都水滴">
<meta property="og:title" content="PVE 磁盘巡检接入 Uptime Kuma——踩坑 404 的来龙去脉与最终脚本 - 魔都水滴">
<meta property="og:description" content="写在前面 前一篇文章教大家把 PVE 宿主机的 LVM‑Thin 用量推到 Uptime Kuma。 有同学照做后 curl 推送却报 404。本文完整复盘原因、修正脚本，并给出 可选升级方案。零基础跟着做，保证一次成功。 1 现象：curl … 404 curl -fsS --retry 3 \ …">
<meta property="og:url" content="https://blog.margrop.net/post/pve-host-virtual-machine-disk-space-monitor-experience-step-two/">
<meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.margrop.net/images/avatar.png"><meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="PVE 磁盘巡检接入 Uptime Kuma——踩坑 404 的来龙去脉与最终脚本 - 魔都水滴">
<meta name="twitter:description" content="写在前面 前一篇文章教大家把 PVE 宿主机的 LVM‑Thin 用量推到 Uptime Kuma。 有同学照做后 curl 推送却报 404。本文完整复盘原因、修正脚本，并给出 可选升级方案。零基础跟着做，保证一次成功。 1 现象：curl … 404 curl -fsS --retry 3 \ …"><meta name="twitter:image" content="https://blog.margrop.net/images/avatar.png"><meta property="article:published_time" content="2025-05-14T22:16:48&#43;08:00">
<meta property="article:modified_time" content="2025-05-14T22:16:48&#43;08:00"><meta property="article:tag" content="Proxmox VE"><meta property="article:tag" content="lvm"><meta property="article:tag" content="UptimeKuma"><meta property="article:tag" content="Shell"><meta property="article:tag" content="crontab"><meta property="article:tag" content="运维监控"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"魔都水滴"},"dateModified":"2025-05-14T22:16:48+08:00","datePublished":"2025-05-14T22:16:48+08:00","description":"写在前面 前一篇文章教大家把 PVE 宿主机的 LVM‑Thin 用量推到 Uptime Kuma。 有同学照做后 curl 推送却报 404。本文完整复盘原因、修正脚本，并给出 可选升级方案。零基础跟着做，保证一次成功。 1 现象：curl … 404 curl -fsS --retry 3 \\ …","headline":"PVE 磁盘巡检接入 Uptime Kuma——踩坑 404 的来龙去脉与最终脚本","mainEntityOfPage":"https://blog.margrop.net/post/pve-host-virtual-machine-disk-space-monitor-experience-step-two/","url":"https://blog.margrop.net/post/pve-host-virtual-machine-disk-space-monitor-experience-step-two/"}</script>
    <meta name="baidu-site-verification" content="code-sVFZ8SER59" />
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J2W592DHJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3J2W592DHJ');
    </script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.8; }
        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
        .content { line-height: 1.8; }
        .content code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        .content pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }
        .content img { max-width: 100%; height: auto; }
        .tags { margin-top: 30px; }
        .tag { background: #eee; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
        nav { margin-bottom: 30px; }
        nav a { margin-right: 15px; text-decoration: none; color: #333; }
        nav a:hover { color: #006CFF; }
        a { color: #006CFF; }
    </style>
</head>
<body>
    <nav>
        <a href="/">首页</a>
        <a href="/post/">归档</a>
        <a href="/tag/">标签</a>
    </nav>
    <article>
        <h1>PVE 磁盘巡检接入 Uptime Kuma——踩坑 404 的来龙去脉与最终脚本</h1>
        <div class="meta">
            发布时间: 2025-05-14
            
            | 标签: 
            
                
                <a href="/tag/proxmox-ve"><span class="tag">Proxmox VE</span></a>
            
                
                <a href="/tag/lvm"><span class="tag">lvm</span></a>
            
                
                <a href="/tag/uptimekuma"><span class="tag">UptimeKuma</span></a>
            
                
                <a href="/tag/shell"><span class="tag">Shell</span></a>
            
                
                <a href="/tag/crontab"><span class="tag">crontab</span></a>
            
                
                <a href="/tag/%E8%BF%90%E7%BB%B4%E7%9B%91%E6%8E%A7"><span class="tag">运维监控</span></a>
            
            
        </div>
        <div class="content">
            <blockquote>
<p><strong>写在前面</strong>
前一篇文章教大家把 PVE 宿主机的 LVM‑Thin 用量推到 Uptime Kuma。
有同学照做后 <code>curl</code> 推送却报 <strong>404</strong>。本文完整复盘原因、修正脚本，并给出 <strong>可选升级方案</strong>。零基础跟着做，保证一次成功。</p>
</blockquote>
<hr>
<h2 id="1现象curl--404">1 现象：<code>curl … 404</code></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsS --retry <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PUSH_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">?status=up&amp;msg=OK&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     -H <span style="color:#e6db74">&#39;Content-Type: application/json&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --data-raw <span style="color:#e6db74">&#34;</span>$result<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ↳ curl: (22) The requested URL returned error: 404</span>
</span></span></code></pre></div><p>同一条 URL 用浏览器或 <code>curl GET</code> 又能收到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;ok&#34;</span>:<span style="color:#66d9ef">true</span>}
</span></span></code></pre></div><hr>
<h2 id="2原因旧版uptimekuma只支持-gethead-push">2 原因：旧版 Uptime Kuma <em>只支持 GET/HEAD</em> Push</h2>
<p>一旦 <code>curl</code> 带 <code>--data-raw/-d</code>，HTTP 方法就变 <strong>POST</strong>，而 <strong>Kuma ≤ 1.23.x</strong> 的 Push 路由只注册了 GET/HEAD，因此直接 404。社区里已有多人反馈同样问题，GitHub Issue #3267 被标记为「feature‑request」至今未合并。(<a href="https://github.com/louislam/uptime-kuma/issues/3267?utm_source=chatgpt.com" title="Allow http `POST` ing to the `push-monitor` · Issue #3267 - GitHub">GitHub</a>)</p>
<p>Reddit 4 个月前的讨论同样验证了“POST 会 404，暂无官方解决方案”。(<a href="https://www.reddit.com/r/UptimeKuma/comments/1hx8lfh/can_uptime_kuma_push_monitors_support_post/?utm_source=chatgpt.com" title="Can Uptime Kuma Push Monitors Support POST Requests? - Reddit">Reddit</a>)</p>
<hr>
<h2 id="3两条出路">3 两条出路</h2>
<table>
<thead>
<tr>
<th>方案</th>
<th>思路</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A. 改回纯 GET</strong></td>
<td>不带正文，用 URL 参数（最稳妥）</td>
<td>不想折腾 Kuma 升级</td>
</tr>
<tr>
<td><strong>B. 升级到 2.x β 版 / 自行打补丁</strong></td>
<td>未来版本预期会支持 POST；也可用反向代理把 POST 转 GET</td>
<td>愿意测试新版本、或必须上传大量 JSON 正文</td>
</tr>
</tbody>
</table>
<blockquote>
<p>下文主讲 <strong>方案 A</strong>，保证 5 分钟之内搞定。方案 B 放在文末扩展阅读。</p>
</blockquote>
<hr>
<h2 id="4最终脚本纯get版">4 最终脚本（纯 GET 版）</h2>
<h3 id="41配置文件不变">4.1 配置文件不变</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /etc/lvm_check.conf</span>
</span></span><span style="display:flex;"><span>PUSH_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://192.168.102.146:3001/api/push/E94XDnl557&#34;</span>
</span></span></code></pre></div><h3 id="42推送脚本usrlocalbinlvm_kuma_pushsh">4.2 推送脚本 <code>/usr/local/bin/lvm_kuma_push.sh</code></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># 向 Uptime Kuma 发送 GET 心跳，兼容旧版不支持 POST 的限制</span>
</span></span><span style="display:flex;"><span>source /etc/lvm_check.conf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span> -z <span style="color:#e6db74">&#34;</span>$PUSH_URL<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">{</span> echo <span style="color:#e6db74">&#34;缺少 PUSH_URL&#34;</span>; exit 1; <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>json<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>/usr/local/bin/lvm_check.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>status<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$json<span style="color:#e6db74">&#34;</span> | jq -r <span style="color:#e6db74">&#39;.status&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>encoded_json<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#39;%s&#39;</span> <span style="color:#e6db74">&#34;</span>$json<span style="color:#e6db74">&#34;</span> | jq -sRr @uri<span style="color:#66d9ef">)</span>  <span style="color:#75715e"># URL‑encode 详情</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$status<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ok&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  curl -fsS --retry <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>       <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PUSH_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">?status=up&amp;msg=OK&amp;details=</span><span style="color:#e6db74">${</span>encoded_json<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  problem<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$json<span style="color:#e6db74">&#34;</span> | jq -c <span style="color:#e6db74">&#39;.volumes&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  encoded_prob<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#39;%s&#39;</span> <span style="color:#e6db74">&#34;</span>$problem<span style="color:#e6db74">&#34;</span> | jq -sRr @uri<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  curl -fsS --retry <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>       <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PUSH_URL<span style="color:#e6db74">}</span><span style="color:#e6db74">?status=down&amp;msg=</span><span style="color:#e6db74">${</span>encoded_prob<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;details=</span><span style="color:#e6db74">${</span>encoded_json<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><ul>
<li><strong>完全去掉</strong> <code>--data-raw</code> 和 <code>Content-Type</code>，<code>curl</code> 保持 GET。</li>
<li>把原本想 POST 的 JSON 用 <code>details=</code> 参数 URL‑encode 后附在尾部；在 Kuma 的「Maintenance Log」里依然能看到完整内容。</li>
</ul>
<h3 id="43cron-不变">4.3 Cron 不变</h3>
<pre tabindex="0"><code class="language-cron" data-lang="cron">*/5 * * * * /usr/local/bin/lvm_kuma_push.sh &gt;/dev/null 2&gt;&amp;1
</code></pre><hr>
<h2 id="5验证步骤">5 验证步骤</h2>
<ol>
<li>
<p><strong>手动执行脚本</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/local/bin/lvm_kuma_push.sh
</span></span></code></pre></div><p>在 Kuma web 界面应立即出现一次绿色 <strong>Up</strong> 心跳。</p>
</li>
<li>
<p><strong>模拟磁盘告警</strong></p>
<ul>
<li>临时把 <code>THRESHOLD=90</code> 改成 <code>1</code> → 再执行脚本</li>
<li>Kuma 立刻标红，并显示 <code>msg</code> 为 JSON 里触发的卷列表</li>
<li>改回 90，空间正常后再次 Up</li>
</ul>
</li>
</ol>
<hr>
<h2 id="6扩展阅读想用post怎么办">6 扩展阅读：想用 POST 怎么办？</h2>
<ol>
<li>
<p><strong>升级到 Kuma 2.x β</strong>
2.x 开始重构后端，社区 PR 中已有对 Push 路由的增强；在正式 GA 前可试用 β 版（自行评估风险）。</p>
</li>
<li>
<p><strong>反向代理转发</strong>
Nginx 片段示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/api/push/</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass_request_body</span> <span style="color:#66d9ef">off</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://kuma:3001</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Content-Length</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Original-Method</span> $request_method;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>搭配 Lua / middleware 把 POST 改写成 GET（参考 alertmanager‑kuma‑push 项目）。</p>
</li>
</ol>
<hr>
<h2 id="7总结一张图">7 总结一张图</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>lvm_check.sh  ──&gt;  lvm_kuma_push.sh (GET)  ──&gt;  Uptime Kuma Push Monitor
</span></span><span style="display:flex;"><span>     ↑ JSON              ↑ URL 参数
</span></span><span style="display:flex;"><span>     └─────── cron */5 ───────┘
</span></span></code></pre></div><ul>
<li><strong>404 根因</strong>：旧版 Kuma Push Monitor 不认 POST；去掉正文即可。</li>
<li><strong>零依赖</strong>：脚本仍仅需 <code>jq</code>、<code>bc</code>、<code>curl</code>。</li>
<li><strong>未来可扩展</strong>：待 Kuma 官方支持 POST 后，再把 <code>--data-raw</code> 加回来即可。</li>
</ul>
<p>至此，PVE 宿主机磁盘巡检成功接入 Uptime Kuma，并解决了 404 大坑。祝各位再也不怕凌晨磁盘打满！</p>
        </div>
    </article>
    
    
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container" style="margin-top:40px"></div>
<script>
  (function(){
    var gitalk = new Gitalk({
      clientID: '3181fd94e501cc5db0ad',
      clientSecret: 'af1dab79dae02c69296e6615bfcecf47fc8615ee',
      repo: 'margropcomment.margrop.io',
      owner: 'margrop',
      admin: ["margrop"],
      
      id: '\/post\/pve-host-virtual-machine-disk-space-monitor',
      
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  })();
</script>
  



    <script type="text/javascript" src="https://js.users.51.la/21044367.js"></script>
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({id: "1vVTUWl7zoRjnKXi",ck: "1vVTUWl7zoRjnKXi"})</script>
    <script src="https://sdk.51.la/perf/js-sdk-perf.min.js" crossorigin="anonymous"></script>
    <script>
      new LingQue.Monitor().init({id:"202teQt8THXwqyve"});
    </script>
</body>
</html>
