<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Java基于 SpringBoot 的 JNI 本地方法库加载器 - 魔都水滴</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="baidu-site-verification" content="code-sVFZ8SER59" />
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3J2W592DHJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3J2W592DHJ');
    </script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.8; }
        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
        .content { line-height: 1.8; }
        .content code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
        .content pre { background: #f4f4f4; padding: 15px; overflow-x: auto; border-radius: 5px; }
        .content img { max-width: 100%; height: auto; }
        .tags { margin-top: 30px; }
        .tag { background: #eee; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
        nav { margin-bottom: 30px; }
        nav a { margin-right: 15px; text-decoration: none; color: #333; }
        nav a:hover { color: #006CFF; }
        a { color: #006CFF; }
    </style>
</head>
<body>
    <nav>
        <a href="/">首页</a>
        <a href="/post/">归档</a>
        <a href="/tag/">标签</a>
    </nav>
    <article>
        <h1>Java基于 SpringBoot 的 JNI 本地方法库加载器</h1>
        <div class="meta">
            发布时间: 2021-03-27
            
            | 标签: 
            
                
                <a href="/tag/java"><span class="tag">Java</span></a>
            
                
                <a href="/tag/springboot"><span class="tag">springboot</span></a>
            
                
                <a href="/tag/spring"><span class="tag">spring</span></a>
            
                
                <a href="/tag/jni"><span class="tag">jni</span></a>
            
                
                <a href="/tag/so"><span class="tag">so</span></a>
            
                
                <a href="/tag/dll"><span class="tag">dll</span></a>
            
                
                <a href="/tag/jnilib"><span class="tag">jnilib</span></a>
            
                
                <a href="/tag/dylib"><span class="tag">dylib</span></a>
            
                
                <a href="/tag/macos"><span class="tag">MacOS</span></a>
            
                
                <a href="/tag/linux"><span class="tag">Linux</span></a>
            
                
                <a href="/tag/windows"><span class="tag">Windows</span></a>
            
            
        </div>
        <div class="content">
            <p>由于Java跨平台需要，自行写了一个跨平台的 JNI 本地方法库加载器。</p>
<h1 id="简单实现逻辑">简单实现逻辑</h1>
<ol>
<li>根据环境变量<code>os.name</code>，判断当前系统属于<code>Windows</code>,<code>Linux</code>还是<code>MacOS</code></li>
<li>如果是<code>Linux</code>，继续判断是<code>CentOS</code>还是<code>Debian</code></li>
<li>读取 jar 包中的库文件</li>
<li>根据文件名后缀<code>dll</code>、<code>so</code>、<code>jnilib</code>和<code>dylib</code>，过滤符合当前平台的库文件</li>
<li>将当前平台的库文件复制到系统临时目录<code>java.io.tmpdir</code></li>
<li>使用<code>System.load</code>加载库文件</li>
</ol>
<h1 id="详细代码">详细代码</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> cn.hutool.core.io.IoUtil;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cn.hutool.core.util.StrUtil;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.Logger;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.slf4j.LoggerFactory;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.core.io.Resource;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NativeLibLoader</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory.<span style="color:#a6e22e">getLogger</span>(NativeLibLoader.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">load</span>(String<span style="color:#f92672">[]</span> snks) {
</span></span><span style="display:flex;"><span>        String currentOS <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;os.name&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (currentOS.<span style="color:#a6e22e">contains</span>(<span style="color:#e6db74">&#34;Windows&#34;</span>)) {
</span></span><span style="display:flex;"><span>            linuxPrefix(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;dir&#34;</span>});
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (String snk : snks) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (StrUtil.<span style="color:#a6e22e">endWithIgnoreCase</span>(snk, <span style="color:#e6db74">&#34;dll&#34;</span>)) {
</span></span><span style="display:flex;"><span>                    loadFile(snk, snk);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (currentOS.<span style="color:#a6e22e">contains</span>(<span style="color:#e6db74">&#34;Linux&#34;</span>)) {
</span></span><span style="display:flex;"><span>            String linuxPrefix <span style="color:#f92672">=</span> linuxPrefix(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;/bin/bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;cat /etc/*-release&#34;</span>});
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (String snk : snks) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (StrUtil.<span style="color:#a6e22e">endWithIgnoreCase</span>(snk, <span style="color:#e6db74">&#34;so&#34;</span>)) {
</span></span><span style="display:flex;"><span>                    loadFile(linuxPrefix <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">+</span> snk, snk);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (currentOS.<span style="color:#a6e22e">contains</span>(<span style="color:#e6db74">&#34;Mac OS X&#34;</span>)) {
</span></span><span style="display:flex;"><span>            linuxPrefix(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;ls&#34;</span>});
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (String snk : snks) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (StrUtil.<span style="color:#a6e22e">endWithIgnoreCase</span>(snk, <span style="color:#e6db74">&#34;jnilib&#34;</span>) <span style="color:#f92672">||</span> StrUtil.<span style="color:#a6e22e">endWithIgnoreCase</span>(snk, <span style="color:#e6db74">&#34;dylib&#34;</span>)) {
</span></span><span style="display:flex;"><span>                    loadFile(snk, snk);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            logger.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;NativeLibLoader : not supported &#34;</span> <span style="color:#f92672">+</span> currentOS);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">linuxPrefix</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        StringBuilder sbRead <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>        StringBuilder sbErr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 启动另一个进程来执行命令</span>
</span></span><span style="display:flex;"><span>            Process pro <span style="color:#f92672">=</span> Runtime.<span style="color:#a6e22e">getRuntime</span>().<span style="color:#a6e22e">exec</span>(args);
</span></span><span style="display:flex;"><span>            pro.<span style="color:#a6e22e">waitFor</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> (BufferedReader read <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(<span style="color:#66d9ef">new</span> InputStreamReader(pro.<span style="color:#a6e22e">getInputStream</span>()));
</span></span><span style="display:flex;"><span>                 BufferedReader err <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(<span style="color:#66d9ef">new</span> InputStreamReader(pro.<span style="color:#a6e22e">getErrorStream</span>()))) {
</span></span><span style="display:flex;"><span>                String line;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> ((line <span style="color:#f92672">=</span> read.<span style="color:#a6e22e">readLine</span>()) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    logger.<span style="color:#a6e22e">info</span>(line);
</span></span><span style="display:flex;"><span>                    sbRead.<span style="color:#a6e22e">append</span>(line);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> ((line <span style="color:#f92672">=</span> err.<span style="color:#a6e22e">readLine</span>()) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    logger.<span style="color:#a6e22e">error</span>(line);
</span></span><span style="display:flex;"><span>                    sbErr.<span style="color:#a6e22e">append</span>(line);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String releaseInfo <span style="color:#f92672">=</span> sbRead.<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (releaseInfo.<span style="color:#a6e22e">contains</span>(<span style="color:#e6db74">&#34;Debian&#34;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;debian&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;centos&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadFile</span>(String src, String snk) {
</span></span><span style="display:flex;"><span>        String srcAndPath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;classpath:&#34;</span> <span style="color:#f92672">+</span> src;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            logger.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;NativeLibLoader : copy &#34;</span> <span style="color:#f92672">+</span> srcAndPath <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; to &#34;</span> <span style="color:#f92672">+</span> snk);
</span></span><span style="display:flex;"><span>            File file <span style="color:#f92672">=</span> copyResourceToTempDirFile(srcAndPath, snk);
</span></span><span style="display:flex;"><span>            String filePath <span style="color:#f92672">=</span> file.<span style="color:#a6e22e">getAbsolutePath</span>();
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">load</span>(filePath);
</span></span><span style="display:flex;"><span>            logger.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;NativeLibLoader : load &#34;</span> <span style="color:#f92672">+</span> filePath <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; successful&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> File <span style="color:#a6e22e">copyResourceToTempDirFile</span>(String src, String snk) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        File tempDir <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File(System.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;java.io.tmpdir&#34;</span>));
</span></span><span style="display:flex;"><span>        File tempDirFile <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File(tempDir, snk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        PathMatchingResourcePatternResolver patternResolver <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PathMatchingResourcePatternResolver();
</span></span><span style="display:flex;"><span>        Resource<span style="color:#f92672">[]</span> resources <span style="color:#f92672">=</span> patternResolver.<span style="color:#a6e22e">getResources</span>(src);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (resources.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 0) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> (InputStream input <span style="color:#f92672">=</span> resources<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.<span style="color:#a6e22e">getInputStream</span>();
</span></span><span style="display:flex;"><span>             OutputStream output <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream(tempDirFile)) {
</span></span><span style="display:flex;"><span>            IoUtil.<span style="color:#a6e22e">copy</span>(input, output);
</span></span><span style="display:flex;"><span>            tempDirFile.<span style="color:#a6e22e">deleteOnExit</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> tempDirFile;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="如何加载">如何加载</h1>
<ul>
<li>启动时，运行<code>NativeLibLoader.load()</code>方法即可</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>NativeLibLoader.<span style="color:#a6e22e">load</span>(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;jniortools.dll&#34;</span>, <span style="color:#e6db74">&#34;libortools.so&#34;</span>, <span style="color:#e6db74">&#34;libjniortools.so&#34;</span>, <span style="color:#e6db74">&#34;libortools.dylib&#34;</span>, <span style="color:#e6db74">&#34;libjniortools.jnilib&#34;</span>});
</span></span></code></pre></div>
        </div>
    
    
  
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<div id="gitalk-container" style="margin-top:40px"></div>
<script>
  (function(){
    var gitalk = new Gitalk({
      clientID: '3181fd94e501cc5db0ad',
      clientSecret: 'af1dab79dae02c69296e6615bfcecf47fc8615ee',
      repo: 'margropcomment.margrop.io',
      owner: 'margrop',
      admin: "[\"margrop\"]",
      id: 'a7c91ae99010c67ca9e5901ce371be6ec03b3656',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  })();
</script>
  



    <script type="text/javascript" src="https://js.users.51.la/21044367.js"></script>
</body>
</html>
